/**
 * VulnerabilityCommandTable — v0.4 dark-only rewrite.
 *
 * Uses shared SeverityBadge and CvssScore components.
 * Full keyboard navigation with arrow keys, space to select, enter to view details.
 */

import React, { useState, useRef, useEffect, useCallback } from "react";
import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  getFilteredRowModel,
  flexRender,
  type ColumnDef,
  type SortingState,
  type RowSelectionState,
  createColumnHelper,
  type Updater,
} from "@tanstack/react-table";
import { ChevronDown, ChevronUp, ExternalLink, Eye, Shield } from "lucide-react";
import { cn } from "~/components/lib/utils";
import { SeverityBadge } from "~/components/shared/SeverityBadge";
import { CvssScore } from "~/components/shared/CvssScore";

/* ------------------------------------------------------------------ */
/*  Types                                                              */
/* ------------------------------------------------------------------ */

export interface VulnTableItem {
  cve: string;
  severity: "CRITICAL" | "HIGH" | "MEDIUM" | "LOW" | "INFORMATIONAL";
  description: string;
  riskScore: number;
  affectedHosts: string[];
  published?: string;
  lastModified?: string;
  references?: string[];
  cpe?: string[];
  fixed?: boolean;
  exploit?: boolean;
  selected?: boolean;
}

interface VulnerabilityCommandTableProps {
  data: VulnTableItem[];
  onSelectRow?: (selectedRows: string[]) => void;
  onViewDetails?: (cve: string) => void;
  onRefresh?: () => void;
  selectedRows?: string[];
  isLoading?: boolean;
}

/* ------------------------------------------------------------------ */
/*  Component                                                          */
/* ------------------------------------------------------------------ */

export const VulnerabilityCommandTable = ({
  data,
  onSelectRow,
  onViewDetails,
  selectedRows = [],
  isLoading = false,
}: VulnerabilityCommandTableProps) => {
  const [sorting, setSorting] = useState<SortingState>([
    { id: "severity", desc: false },
  ]);
  const [rowSelection, setRowSelection] = useState<RowSelectionState>({});
  const [expandedRows, setExpandedRows] = useState<Record<string, boolean>>({});
  const [hoveredRowIndex, setHoveredRowIndex] = useState<string | null>(null);
  const [focusedRowIndex, setFocusedRowIndex] = useState<number | null>(null);
  const tableContainerRef = useRef<HTMLDivElement>(null);

  /* ---- Column definitions ---- */
  const columnHelper = createColumnHelper<VulnTableItem>();

  const columns = [
    // Checkbox
    columnHelper.display({
      id: "select",
      header: ({ table }) => (
        <div className="px-1">
          <input
            type="checkbox"
            checked={table.getIsAllRowsSelected()}
            onChange={(e) => {
              table.getToggleAllRowsSelectedHandler()(e);
              e.stopPropagation();
            }}
            onClick={(e) => {
              e.stopPropagation();
              e.nativeEvent.stopImmediatePropagation();
            }}
            className="h-4 w-4 rounded border-gray-600 bg-gray-800 text-violet-500 focus:ring-violet-500/30"
          />
        </div>
      ),
      cell: ({ row }) => (
        <div className="px-1" onClick={(e) => e.stopPropagation()}>
          <input
            type="checkbox"
            checked={row.getIsSelected()}
            onChange={(e) => {
              e.stopPropagation();
              e.nativeEvent.stopImmediatePropagation();
              setTimeout(() => row.toggleSelected(), 0);
            }}
            onClick={(e) => {
              e.stopPropagation();
              e.nativeEvent.stopImmediatePropagation();
            }}
            className="h-4 w-4 rounded border-gray-600 bg-gray-800 text-violet-500 focus:ring-violet-500/30"
          />
        </div>
      ),
      size: 40,
    }),

    // Severity
    columnHelper.accessor("severity", {
      header: "Severity",
      cell: ({ getValue }) => (
        <SeverityBadge severity={getValue()} variant="scanner" />
      ),
      size: 100,
      enableSorting: true,
    }),

    // CVE ID
    columnHelper.accessor("cve", {
      header: "CVE ID",
      cell: ({ getValue }) => (
        <span className="font-mono text-xs font-medium text-white">
          {getValue()}
        </span>
      ),
      size: 140,
    }),

    // CVSS Score
    columnHelper.accessor("riskScore", {
      header: "CVSS",
      cell: ({ getValue }) => <CvssScore score={getValue()} />,
      size: 100,
      enableSorting: true,
    }),

    // Description
    columnHelper.accessor("description", {
      header: "Description",
      cell: ({ getValue, row }) => {
        const isExpanded = expandedRows[row.id];
        const text = getValue();
        return (
          <div>
            <div
              className={cn(
                "text-xs text-gray-300",
                !isExpanded && "line-clamp-1",
              )}
            >
              {text}
            </div>
            {text.length > 120 && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  setExpandedRows((prev) => ({
                    ...prev,
                    [row.id]: !prev[row.id],
                  }));
                }}
                className="mt-0.5 text-xs text-violet-400 hover:text-violet-300"
              >
                {isExpanded ? "Show less" : "Show more"}
              </button>
            )}
          </div>
        );
      },
      size: 450,
    }),

    // Actions
    columnHelper.display({
      id: "actions",
      header: "",
      cell: ({ row }) => {
        const rowIndex = parseInt(row.id);
        const isHovered =
          hoveredRowIndex === row.id || focusedRowIndex === rowIndex;
        const cve = row.original.cve;

        return (
          <div
            className={cn(
              "flex items-center justify-end gap-1 pr-2 transition-opacity",
              isHovered ? "opacity-100" : "opacity-0 group-hover:opacity-100",
            )}
          >
            <button
              onClick={(e) => {
                e.stopPropagation();
                onViewDetails?.(cve);
              }}
              className="rounded p-1 text-gray-400 hover:bg-gray-800 hover:text-violet-400"
              title="View vulnerability details"
            >
              <Eye className="h-3.5 w-3.5" />
            </button>
            <a
              href={`https://nvd.nist.gov/vuln/detail/${cve}`}
              target="_blank"
              rel="noopener noreferrer"
              className="rounded p-1 text-gray-400 hover:bg-gray-800 hover:text-blue-400"
              title="View in NVD database"
              onClick={(e) => e.stopPropagation()}
            >
              <ExternalLink className="h-3.5 w-3.5" />
            </a>
          </div>
        );
      },
      size: 80,
    }),

    // Affected Hosts
    columnHelper.accessor("affectedHosts", {
      header: "Hosts",
      cell: ({ getValue }) => (
        <div className="text-center">
          <span className="text-xs font-medium text-white">
            {getValue().length}
          </span>
        </div>
      ),
      size: 60,
      enableSorting: true,
    }),
  ] as ColumnDef<VulnTableItem>[];

  /* ---- Sync external selection ---- */
  const prevSelectedRowsRef = useRef<string[]>(selectedRows);

  useEffect(() => {
    prevSelectedRowsRef.current = selectedRows;
    const currentCVEs = Object.keys(rowSelection)
      .map((idx) => data[parseInt(idx)]?.cve)
      .filter(Boolean);
    const changed =
      selectedRows.length !== currentCVEs.length ||
      selectedRows.some((cve) => !currentCVEs.includes(cve));

    if (changed) {
      if (selectedRows.length === 0 && Object.keys(rowSelection).length > 0) {
        setRowSelection({});
      } else if (selectedRows.length > 0) {
        const sel: RowSelectionState = {};
        selectedRows.forEach((cve) => {
          const idx = data.findIndex((item) => item.cve === cve);
          if (idx !== -1) sel[idx] = true;
        });
        setRowSelection(sel);
      }
    }
  }, [selectedRows, data, rowSelection]);

  /* ---- Selection change callback ---- */
  const handleSelectionChange = useCallback(
    (updaterOrValue: Updater<RowSelectionState>) => {
      const newSel =
        typeof updaterOrValue === "function"
          ? updaterOrValue(rowSelection)
          : updaterOrValue;
      setRowSelection(newSel);

      if (onSelectRow) {
        const cves = Object.keys(newSel)
          .map((idx) => data[parseInt(idx)]?.cve)
          .filter((c): c is string => c !== undefined);
        onSelectRow(cves);
      }
    },
    [data, onSelectRow, rowSelection],
  );

  /* ---- Table instance ---- */
  const table = useReactTable({
    data,
    columns,
    state: { sorting, rowSelection },
    enableRowSelection: true,
    onRowSelectionChange: handleSelectionChange,
    onSortingChange: setSorting,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
  });

  /* ---- Focus container on mount ---- */
  useEffect(() => {
    if (tableContainerRef.current && data.length > 0) {
      tableContainerRef.current.focus();
      if (focusedRowIndex === null) setFocusedRowIndex(0);
    }
  }, [data, focusedRowIndex]);

  /* ---- Keyboard navigation ---- */
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (focusedRowIndex === null && data.length > 0) {
      setFocusedRowIndex(0);
      return;
    }
    if (focusedRowIndex === null) return;

    switch (e.key) {
      case "ArrowDown":
        e.preventDefault();
        if (focusedRowIndex < data.length - 1)
          setFocusedRowIndex(focusedRowIndex + 1);
        break;
      case "ArrowUp":
        e.preventDefault();
        if (focusedRowIndex > 0) setFocusedRowIndex(focusedRowIndex - 1);
        break;
      case "Enter":
        e.preventDefault();
        if (data[focusedRowIndex]) onViewDetails?.(data[focusedRowIndex].cve);
        break;
      case " ":
        e.preventDefault();
        e.stopPropagation();
        if (focusedRowIndex !== null) {
          setTimeout(() => {
            table.setRowSelection((prev) => ({
              ...prev,
              [focusedRowIndex]: !prev[focusedRowIndex],
            }));
          }, 0);
        }
        break;
    }
  };

  /* ---- Render ---- */
  return (
    <div
      ref={tableContainerRef}
      className="relative h-full overflow-auto outline-none"
      tabIndex={0}
      onKeyDown={handleKeyDown}
    >
      <table className="w-full table-fixed border-collapse">
        <thead className="sticky top-0 z-10">
          {table.getHeaderGroups().map((hg) => (
            <tr key={hg.id} className="border-b border-violet-500/10">
              {hg.headers.map((header) => (
                <th
                  key={header.id}
                  style={{ width: `${header.column.getSize()}px` }}
                  className={cn(
                    "bg-gray-900/50 px-3 py-2 text-left text-xs font-semibold uppercase tracking-wider text-gray-400",
                    header.column.getCanSort() && "cursor-pointer select-none",
                  )}
                  onClick={header.column.getToggleSortingHandler()}
                >
                  <div className="flex items-center">
                    {flexRender(
                      header.column.columnDef.header,
                      header.getContext(),
                    )}
                    {header.column.getCanSort() && (
                      <div className="ml-1">
                        {header.column.getIsSorted() === "asc" ? (
                          <ChevronUp className="h-3 w-3" />
                        ) : header.column.getIsSorted() === "desc" ? (
                          <ChevronDown className="h-3 w-3" />
                        ) : (
                          <div className="h-3 w-3" />
                        )}
                      </div>
                    )}
                  </div>
                </th>
              ))}
            </tr>
          ))}
        </thead>
        <tbody>
          {isLoading ? (
            <tr>
              <td colSpan={columns.length} className="py-10 text-center">
                <div className="flex flex-col items-center justify-center">
                  <div className="h-8 w-8 animate-spin rounded-full border-2 border-gray-600 border-t-violet-500" />
                  <span className="mt-2 text-sm text-gray-400">
                    Loading vulnerabilities...
                  </span>
                </div>
              </td>
            </tr>
          ) : table.getRowModel().rows.length === 0 ? (
            <tr>
              <td colSpan={columns.length} className="py-10 text-center">
                <div className="flex flex-col items-center justify-center">
                  <Shield className="h-10 w-10 text-gray-400" />
                  <span className="mt-2 text-sm text-gray-400">
                    No vulnerabilities found
                  </span>
                </div>
              </td>
            </tr>
          ) : (
            table.getRowModel().rows.map((row) => {
              const rowIndex = parseInt(row.id);
              return (
                <tr
                  key={row.id}
                  className={cn(
                    "group border-b border-violet-500/5 transition-colors duration-100",
                    hoveredRowIndex === row.id && "bg-gray-800/50",
                    row.getIsSelected() &&
                      "border-l-2 border-l-violet-500 bg-violet-500/10",
                    focusedRowIndex === rowIndex &&
                      !row.getIsSelected() &&
                      "bg-violet-500/5",
                    "cursor-pointer",
                  )}
                  onMouseEnter={() => setHoveredRowIndex(row.id)}
                  onMouseLeave={() => setHoveredRowIndex(null)}
                  onClick={(e) => {
                    const target = e.target as Element;
                    const isControl =
                      target instanceof HTMLInputElement ||
                      target instanceof HTMLButtonElement ||
                      target instanceof HTMLAnchorElement ||
                      target.closest?.("input, button, a");
                    if (!isControl) {
                      setFocusedRowIndex(rowIndex);
                      if (!e.defaultPrevented) row.toggleSelected();
                    }
                  }}
                >
                  {row.getVisibleCells().map((cell) => (
                    <td key={cell.id} className="px-3 py-2 text-xs">
                      {flexRender(
                        cell.column.columnDef.cell,
                        cell.getContext(),
                      )}
                    </td>
                  ))}
                </tr>
              );
            })
          )}
        </tbody>
      </table>

      {/* Keyboard shortcuts help */}
      <div className="absolute bottom-2 right-2 text-xs text-gray-500">
        <kbd className="rounded border border-gray-700 bg-gray-800 px-1 py-0.5 font-mono">
          ↑↓
        </kbd>{" "}
        Navigate{" "}
        <kbd className="ml-1 rounded border border-gray-700 bg-gray-800 px-1 py-0.5 font-mono">
          Space
        </kbd>{" "}
        Select{" "}
        <kbd className="ml-1 rounded border border-gray-700 bg-gray-800 px-1 py-0.5 font-mono">
          Enter
        </kbd>{" "}
        View Details
      </div>
    </div>
  );
};

export default VulnerabilityCommandTable;
