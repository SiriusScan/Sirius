import React from "react";
import { SEVERITY_COLORS, type SeverityLevel } from "~/utils/severityTheme";

/* ------------------------------------------------------------------ */
/*  Severity card order                                                */
/* ------------------------------------------------------------------ */

const SEVERITY_CARD_ORDER: Array<{
  key: SeverityLevel;
  label: string;
  countKey: string;
}> = [
  { key: "critical", label: "Critical", countKey: "critical" },
  { key: "high", label: "High", countKey: "high" },
  { key: "medium", label: "Medium", countKey: "medium" },
  { key: "low", label: "Low", countKey: "low" },
  { key: "info", label: "Info", countKey: "informational" },
];

/* ------------------------------------------------------------------ */
/*  Shared types                                                       */
/* ------------------------------------------------------------------ */

interface VulnerabilitySeverityCardsProps {
  counts: {
    critical: number;
    high: number;
    medium: number;
    low: number;
    informational: number;
  };
}

/* ------------------------------------------------------------------ */
/*  Single card                                                        */
/* ------------------------------------------------------------------ */

const SeverityCard: React.FC<{
  count: number;
  label: string;
  severityKey: SeverityLevel;
}> = ({ count, label, severityKey }) => {
  const colors = SEVERITY_COLORS[severityKey];
  const isEmpty = count === 0;

  return (
    <div
      className={`
        flex flex-col items-center rounded-lg p-4
        shadow-sm shadow-black/25 transition-all duration-150
        hover:brightness-110 hover:shadow-md hover:shadow-black/30
        ${colors.cardBg}
        ${isEmpty ? "opacity-40" : ""}
      `}
    >
      <span className="text-2xl font-bold tabular-nums text-white">
        {count}
      </span>
      <span className="text-[10px] font-semibold uppercase tracking-wider text-white/70">
        {label}
      </span>
    </div>
  );
};

/* ------------------------------------------------------------------ */
/*  Distribution bar                                                   */
/* ------------------------------------------------------------------ */

const DistributionBar: React.FC<{ counts: VulnerabilitySeverityCardsProps["counts"] }> = ({
  counts,
}) => {
  const total =
    counts.critical + counts.high + counts.medium + counts.low + counts.informational;
  if (total === 0) return null;

  return (
    <div className="mt-2 grid grid-cols-5 gap-3">
      {SEVERITY_CARD_ORDER.map(({ key, countKey }) => {
        const value = counts[countKey as keyof typeof counts];
        const pct = total > 0 ? (value / total) * 100 : 0;
        return (
          <div
            key={key}
            className="h-1 overflow-hidden rounded-full bg-gray-800/40"
          >
            {pct > 0 && (
              <div
                className="h-1 rounded-full"
                style={{
                  width: `${pct}%`,
                  backgroundColor: SEVERITY_COLORS[key].cardHex,
                }}
              />
            )}
          </div>
        );
      })}
    </div>
  );
};

/* ------------------------------------------------------------------ */
/*  Vertical layout                                                    */
/* ------------------------------------------------------------------ */

export const VulnerabilitySeverityCardsVertical: React.FC<
  VulnerabilitySeverityCardsProps
> = ({ counts }) => {
  return (
    <div className="flex flex-col gap-2">
      {SEVERITY_CARD_ORDER.map(({ key, label, countKey }) => (
        <SeverityCard
          key={key}
          label={label}
          count={counts[countKey as keyof typeof counts]}
          severityKey={key}
        />
      ))}
      <DistributionBar counts={counts} />
    </div>
  );
};

/* ------------------------------------------------------------------ */
/*  Horizontal (responsive) layout                                     */
/* ------------------------------------------------------------------ */

export const VulnerabilitySeverityCardsHorizontal: React.FC<
  VulnerabilitySeverityCardsProps
> = ({ counts }) => {
  return (
    <div className="flex flex-col gap-0">
      <div className="grid grid-cols-5 gap-3">
        {SEVERITY_CARD_ORDER.map(({ key, label, countKey }) => (
          <SeverityCard
            key={key}
            label={label}
            count={counts[countKey as keyof typeof counts]}
            severityKey={key}
          />
        ))}
      </div>
      <DistributionBar counts={counts} />
    </div>
  );
};

/* ------------------------------------------------------------------ */
/*  Legacy export alias                                                */
/* ------------------------------------------------------------------ */

export const VulnerabilityCount = SeverityCard;
