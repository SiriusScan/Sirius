import React, { useState, useMemo } from "react";
import dynamic from "next/dynamic";
import { Button } from "~/components/lib/ui/button";
import { Skeleton } from "~/components/lib/ui/skeleton";

const ResponsiveLine = dynamic(
  () => import("@nivo/line").then((m) => m.ResponsiveLine),
  { ssr: false }
);

interface VulnerabilityCounts {
  critical: number;
  high: number;
  medium: number;
  low: number;
  informational: number;
}

interface VulnerabilityTrendChartProps {
  currentCounts: VulnerabilityCounts;
  className?: string;
  height?: number;
}

// Static mock historical data - represents a typical 7-day trend
const STATIC_MOCK_HISTORY: VulnerabilityCounts[] = [
  { critical: 15, high: 32, medium: 68, low: 142, informational: 28 },
  { critical: 14, high: 35, medium: 71, low: 138, informational: 31 },
  { critical: 12, high: 38, medium: 74, low: 145, informational: 35 },
  { critical: 13, high: 36, medium: 69, low: 140, informational: 33 },
  { critical: 14, high: 34, medium: 72, low: 143, informational: 30 },
  { critical: 12, high: 37, medium: 70, low: 141, informational: 32 },
  { critical: 12, high: 35, medium: 68, low: 145, informational: 35 }, // Today
];

const VulnerabilityTrendChartComponent: React.FC<
  VulnerabilityTrendChartProps
> = ({ currentCounts, className = "", height = 300 }) => {
  const [viewMode, setViewMode] = useState<"stacked" | "lines">("stacked");

  // Generate chart data using static mock history
  const chartData = useMemo(() => {
    const timeLabels = [
      "6 days ago",
      "5 days ago",
      "4 days ago",
      "3 days ago",
      "2 days ago",
      "Yesterday",
      "Today",
    ];

    return [
      {
        id: "Critical",
        color: "#dc2626",
        data: STATIC_MOCK_HISTORY.map((counts, i) => ({
          x: timeLabels[i],
          y: counts.critical,
        })),
      },
      {
        id: "High",
        color: "#ea580c",
        data: STATIC_MOCK_HISTORY.map((counts, i) => ({
          x: timeLabels[i],
          y: counts.high,
        })),
      },
      {
        id: "Medium",
        color: "#ca8a04",
        data: STATIC_MOCK_HISTORY.map((counts, i) => ({
          x: timeLabels[i],
          y: counts.medium,
        })),
      },
      {
        id: "Low",
        color: "#16a34a",
        data: STATIC_MOCK_HISTORY.map((counts, i) => ({
          x: timeLabels[i],
          y: counts.low,
        })),
      },
      {
        id: "Informational",
        color: "#2563eb",
        data: STATIC_MOCK_HISTORY.map((counts, i) => ({
          x: timeLabels[i],
          y: counts.informational,
        })),
      },
    ];
  }, []); // Empty dependency array - static data doesn't change

  const theme = {
    text: {
      fontSize: 11,
      fill: "currentColor",
    },
    axis: {
      domain: {
        line: {
          stroke: "currentColor",
          strokeWidth: 1,
          strokeOpacity: 0.2,
        },
      },
      legend: {
        text: {
          fontSize: 12,
          fill: "currentColor",
        },
      },
      ticks: {
        line: {
          stroke: "currentColor",
          strokeWidth: 1,
          strokeOpacity: 0.2,
        },
        text: {
          fontSize: 10,
          fill: "currentColor",
          opacity: 0.7,
        },
      },
    },
    grid: {
      line: {
        stroke: "currentColor",
        strokeWidth: 1,
        strokeOpacity: 0.1,
      },
    },
    legends: {
      text: {
        fontSize: 11,
        fill: "currentColor",
      },
    },
    tooltip: {
      container: {
        background: "hsl(var(--background))",
        color: "hsl(var(--foreground))",
        fontSize: 12,
        borderRadius: "6px",
        boxShadow: "0 4px 6px -1px rgb(0 0 0 / 0.1)",
        border: "1px solid hsl(var(--border))",
      },
    },
  };

  return (
    <div className={`flex flex-col ${className}`}>
      {/* Controls */}
      <div className="mb-3 flex items-center justify-between">
        <div className="flex gap-2">
          <Button
            size="sm"
            variant={viewMode === "stacked" ? "default" : "outline"}
            onClick={() => setViewMode("stacked")}
            className="h-7 px-3 text-xs"
          >
            Stacked
          </Button>
          <Button
            size="sm"
            variant={viewMode === "lines" ? "default" : "outline"}
            onClick={() => setViewMode("lines")}
            className="h-7 px-3 text-xs"
          >
            By Severity
          </Button>
        </div>
        <span className="text-xs text-muted-foreground">
          Simulated 7-day trend
        </span>
      </div>

      {/* Chart */}
      <div style={{ height: `${height}px` }}>
        <ResponsiveLine
          data={chartData}
          theme={theme}
          colors={(d) => d.color}
          margin={{ top: 10, right: 110, bottom: 40, left: 50 }}
          xScale={{ type: "point" }}
          yScale={{
            type: "linear",
            min: 0,
            max: "auto",
            stacked: viewMode === "stacked",
            reverse: false,
          }}
          curve="monotoneX"
          axisTop={null}
          axisRight={null}
          axisBottom={{
            tickSize: 5,
            tickPadding: 5,
            tickRotation: -15,
            legendOffset: 36,
            legendPosition: "middle",
          }}
          axisLeft={{
            tickSize: 5,
            tickPadding: 5,
            tickRotation: 0,
            legend: "Vulnerabilities",
            legendOffset: -40,
            legendPosition: "middle",
          }}
          enableGridX={false}
          enableGridY={true}
          lineWidth={viewMode === "lines" ? 2 : 0}
          enableArea={viewMode === "stacked"}
          areaOpacity={viewMode === "stacked" ? 0.7 : 0}
          pointSize={6}
          pointColor="#ffffff"
          pointBorderWidth={2}
          pointBorderColor={{ from: "serieColor" }}
          enablePointLabel={false}
          useMesh={true}
          enableSlices="x"
          legends={[
            {
              anchor: "bottom-right",
              direction: "column",
              justify: false,
              translateX: 100,
              translateY: 0,
              itemsSpacing: 4,
              itemDirection: "left-to-right",
              itemWidth: 80,
              itemHeight: 16,
              itemOpacity: 0.85,
              symbolSize: 10,
              symbolShape: "circle",
              effects: [
                {
                  on: "hover",
                  style: {
                    itemOpacity: 1,
                  },
                },
              ],
            },
          ]}
        />
      </div>
    </div>
  );
};

// Memoized export to prevent unnecessary re-renders
export const VulnerabilityTrendChart = React.memo(
  VulnerabilityTrendChartComponent
);

// Loading skeleton
export const VulnerabilityTrendChartSkeleton: React.FC<{ height?: number }> = ({
  height = 300,
}) => {
  return (
    <div className="flex flex-col space-y-3">
      <div className="flex justify-between">
        <div className="flex gap-2">
          <Skeleton className="h-7 w-20" />
          <Skeleton className="h-7 w-24" />
        </div>
        <Skeleton className="h-4 w-32" />
      </div>
      <Skeleton className="w-full" style={{ height: `${height}px` }} />
    </div>
  );
};
