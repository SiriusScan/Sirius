import React, { useState, useMemo } from "react";
import dynamic from "next/dynamic";
import { Button } from "~/components/lib/ui/button";
import { Skeleton } from "~/components/lib/ui/skeleton";
import { api } from "~/utils/api";

const ResponsiveLine = dynamic(
  () => import("@nivo/line").then((m) => m.ResponsiveLine),
  { ssr: false }
);

interface VulnerabilityCounts {
  critical: number;
  high: number;
  medium: number;
  low: number;
  informational: number;
}

interface VulnerabilityTrendChartProps {
  currentCounts: VulnerabilityCounts;
  className?: string;
  height?: number;
}

const VulnerabilityTrendChartComponent: React.FC<
  VulnerabilityTrendChartProps
> = ({ currentCounts, className = "", height = 300 }) => {
  const [viewMode, setViewMode] = useState<"stacked" | "lines">("stacked");

  // Fetch trends data from API
  const { data: trendsData, isLoading: trendsLoading } =
    api.statistics.getVulnerabilityTrends.useQuery(
      { days: 7 },
      {
        refetchOnWindowFocus: false,
        staleTime: 300000, // 5 minutes
      }
    );

  // Generate chart data from API data or fallback to current counts
  const chartData = useMemo(() => {
    const trends = trendsData?.trends ?? [];

    // If we have no trends yet, create a simple dataset with current counts
    if (trends.length === 0) {
      return [
        {
          id: "Critical",
          color: "#dc2626",
          data: [{ x: "Now", y: currentCounts.critical }],
        },
        {
          id: "High",
          color: "#ea580c",
          data: [{ x: "Now", y: currentCounts.high }],
        },
        {
          id: "Medium",
          color: "#ca8a04",
          data: [{ x: "Now", y: currentCounts.medium }],
        },
        {
          id: "Low",
          color: "#16a34a",
          data: [{ x: "Now", y: currentCounts.low }],
        },
        {
          id: "Informational",
          color: "#2563eb",
          data: [{ x: "Now", y: currentCounts.informational }],
        },
      ];
    }

    // Generate time labels
    const timeLabels = trends.map((trend, i) => {
      const daysAgo = trends.length - 1 - i;
      if (daysAgo === 0) return "Today";
      if (daysAgo === 1) return "Yesterday";
      return `${daysAgo} days ago`;
    });

    return [
      {
        id: "Critical",
        color: "#dc2626",
        data: trends.map((trend, i) => ({
          x: timeLabels[i],
          y: trend.counts.critical,
        })),
      },
      {
        id: "High",
        color: "#ea580c",
        data: trends.map((trend, i) => ({
          x: timeLabels[i],
          y: trend.counts.high,
        })),
      },
      {
        id: "Medium",
        color: "#ca8a04",
        data: trends.map((trend, i) => ({
          x: timeLabels[i],
          y: trend.counts.medium,
        })),
      },
      {
        id: "Low",
        color: "#16a34a",
        data: trends.map((trend, i) => ({
          x: timeLabels[i],
          y: trend.counts.low,
        })),
      },
      {
        id: "Informational",
        color: "#2563eb",
        data: trends.map((trend, i) => ({
          x: timeLabels[i],
          y: trend.counts.informational,
        })),
      },
    ];
  }, [trendsData, currentCounts]);

  const theme = {
    text: {
      fontSize: 11,
      fill: "currentColor",
    },
    axis: {
      domain: {
        line: {
          stroke: "currentColor",
          strokeWidth: 1,
          strokeOpacity: 0.2,
        },
      },
      legend: {
        text: {
          fontSize: 12,
          fill: "currentColor",
        },
      },
      ticks: {
        line: {
          stroke: "currentColor",
          strokeWidth: 1,
          strokeOpacity: 0.2,
        },
        text: {
          fontSize: 10,
          fill: "currentColor",
          opacity: 0.7,
        },
      },
    },
    grid: {
      line: {
        stroke: "currentColor",
        strokeWidth: 1,
        strokeOpacity: 0.1,
      },
    },
    legends: {
      text: {
        fontSize: 11,
        fill: "currentColor",
      },
    },
    tooltip: {
      container: {
        background: "hsl(var(--background))",
        color: "hsl(var(--foreground))",
        fontSize: 12,
        borderRadius: "6px",
        boxShadow: "0 4px 6px -1px rgb(0 0 0 / 0.1)",
        border: "1px solid hsl(var(--border))",
      },
    },
  };

  return (
    <div className={`flex flex-col ${className}`}>
      {/* Controls */}
      <div className="mb-3 flex items-center justify-between">
        <div className="flex gap-2">
          <Button
            size="sm"
            variant={viewMode === "stacked" ? "default" : "outline"}
            onClick={() => setViewMode("stacked")}
            className="h-7 px-3 text-xs"
          >
            Stacked
          </Button>
          <Button
            size="sm"
            variant={viewMode === "lines" ? "default" : "outline"}
            onClick={() => setViewMode("lines")}
            className="h-7 px-3 text-xs"
          >
            By Severity
          </Button>
        </div>
        <span className="text-xs text-muted-foreground">
          {trendsLoading
            ? "Loading trends..."
            : trendsData?.trends && trendsData.trends.length > 0
            ? `${trendsData.days}-day trend`
            : "Current snapshot"}
        </span>
      </div>

      {/* Chart */}
      <div style={{ height: `${height}px` }}>
        <ResponsiveLine
          data={chartData}
          theme={theme}
          colors={(d) => d.color}
          margin={{ top: 10, right: 110, bottom: 40, left: 50 }}
          xScale={{ type: "point" }}
          yScale={{
            type: "linear",
            min: 0,
            max: "auto",
            stacked: viewMode === "stacked",
            reverse: false,
          }}
          curve="monotoneX"
          axisTop={null}
          axisRight={null}
          axisBottom={{
            tickSize: 5,
            tickPadding: 5,
            tickRotation: -15,
            legendOffset: 36,
            legendPosition: "middle",
          }}
          axisLeft={{
            tickSize: 5,
            tickPadding: 5,
            tickRotation: 0,
            legend: "Vulnerabilities",
            legendOffset: -40,
            legendPosition: "middle",
          }}
          enableGridX={false}
          enableGridY={true}
          lineWidth={viewMode === "lines" ? 2 : 0}
          enableArea={viewMode === "stacked"}
          areaOpacity={viewMode === "stacked" ? 0.7 : 0}
          pointSize={6}
          pointColor="#ffffff"
          pointBorderWidth={2}
          pointBorderColor={{ from: "serieColor" }}
          enablePointLabel={false}
          useMesh={true}
          enableSlices="x"
          legends={[
            {
              anchor: "bottom-right",
              direction: "column",
              justify: false,
              translateX: 100,
              translateY: 0,
              itemsSpacing: 4,
              itemDirection: "left-to-right",
              itemWidth: 80,
              itemHeight: 16,
              itemOpacity: 0.85,
              symbolSize: 10,
              symbolShape: "circle",
              effects: [
                {
                  on: "hover",
                  style: {
                    itemOpacity: 1,
                  },
                },
              ],
            },
          ]}
        />
      </div>
    </div>
  );
};

// Memoized export to prevent unnecessary re-renders
export const VulnerabilityTrendChart = React.memo(
  VulnerabilityTrendChartComponent
);

// Loading skeleton
export const VulnerabilityTrendChartSkeleton: React.FC<{ height?: number }> = ({
  height = 300,
}) => {
  return (
    <div className="flex flex-col space-y-3">
      <div className="flex justify-between">
        <div className="flex gap-2">
          <Skeleton className="h-7 w-20" />
          <Skeleton className="h-7 w-24" />
        </div>
        <Skeleton className="h-4 w-32" />
      </div>
      <Skeleton className="w-full" style={{ height: `${height}px` }} />
    </div>
  );
};
