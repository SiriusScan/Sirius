/**
 * VulnerabilityEntryRow — reusable vulnerability input row with CVE auto-lookup.
 *
 * Used by both the AddVulnerabilityPanel wizard and the HostForm
 * vulnerabilities section. Provides CVE ID input with debounced
 * auto-lookup, severity dropdown, CVSS score input, and description.
 */

import React, { useState, useEffect, useRef, useCallback } from "react";
import { Input } from "~/components/lib/ui/input";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "~/components/lib/ui/select";
import { Trash2, Check, AlertTriangle, Loader2 } from "lucide-react";
import { cn } from "~/components/lib/utils";
import { api } from "~/utils/api";

/* ------------------------------------------------------------------ */
/*  Types                                                              */
/* ------------------------------------------------------------------ */

export interface VulnEntryData {
  id: string;
  vid: string;
  title: string;
  description: string;
  severity: string;
  riskScore: number;
  /** Whether the CVE was found via auto-lookup */
  autoFilled: boolean;
}

interface VulnerabilityEntryRowProps {
  entry: VulnEntryData;
  onChange: (updated: VulnEntryData) => void;
  onRemove: () => void;
  /** Show compact layout (for HostForm inline) */
  compact?: boolean;
  /** Index for error display */
  index?: number;
}

/* ------------------------------------------------------------------ */
/*  Severity options                                                   */
/* ------------------------------------------------------------------ */

const SEVERITY_OPTIONS = [
  { value: "critical", label: "Critical" },
  { value: "high", label: "High" },
  { value: "medium", label: "Medium" },
  { value: "low", label: "Low" },
  { value: "informational", label: "Info" },
] as const;

/* ------------------------------------------------------------------ */
/*  Helpers                                                            */
/* ------------------------------------------------------------------ */

/** Map a CVSS score to a severity string */
function cvssToSeverity(score: number): string {
  if (score >= 9.0) return "critical";
  if (score >= 7.0) return "high";
  if (score >= 4.0) return "medium";
  if (score > 0) return "low";
  return "informational";
}

/** Generate unique ID for entries */
export const generateEntryId = () =>
  Math.random().toString(36).substring(2, 9);

/* ------------------------------------------------------------------ */
/*  Component                                                          */
/* ------------------------------------------------------------------ */

export const VulnerabilityEntryRow: React.FC<VulnerabilityEntryRowProps> = ({
  entry,
  onChange,
  onRemove,
  compact = false,
  index,
}) => {
  const [lookupStatus, setLookupStatus] = useState<
    "idle" | "loading" | "found" | "not-found"
  >(entry.autoFilled ? "found" : "idle");
  const [debouncedVid, setDebouncedVid] = useState(entry.vid);
  const debounceTimer = useRef<NodeJS.Timeout | null>(null);

  // Debounce CVE ID input for auto-lookup
  const handleVidChange = useCallback(
    (newVid: string) => {
      const upper = newVid.toUpperCase();
      onChange({ ...entry, vid: upper, autoFilled: false });
      setLookupStatus("idle");

      if (debounceTimer.current) clearTimeout(debounceTimer.current);

      // Only trigger lookup for CVE-format IDs (min length: CVE-XXXX-XXXX)
      if (upper.length >= 9 && upper.startsWith("CVE-")) {
        debounceTimer.current = setTimeout(() => {
          setDebouncedVid(upper);
        }, 600);
      }
    },
    [entry, onChange],
  );

  // Auto-lookup query
  const { data: cveData, isFetching } =
    api.vulnerability.getVulnerability.useQuery(
      { id: debouncedVid },
      {
        enabled:
          debouncedVid.length >= 9 &&
          debouncedVid.startsWith("CVE-") &&
          !entry.autoFilled,
        retry: false,
        staleTime: 1000 * 60 * 10,
      },
    );

  // Update status based on fetch state
  useEffect(() => {
    if (isFetching) {
      setLookupStatus("loading");
    }
  }, [isFetching]);

  // Auto-fill when CVE data arrives
  useEffect(() => {
    if (!cveData || entry.autoFilled) return;

    // Extract description (English)
    const desc =
      cveData.descriptions?.find((d) => d.lang === "en")?.value ?? "";

    // Extract CVSS score
    let score = 0;
    let sev = "informational";
    const v31 = cveData.metrics?.cvssMetricV31?.[0];
    const v30 = cveData.metrics?.cvssMetricV30?.[0];
    if (v31) {
      score = v31.cvssData.baseScore;
      sev = v31.cvssData.baseSeverity?.toLowerCase() ?? cvssToSeverity(score);
    } else if (v30) {
      score = v30.cvssData.baseScore;
      sev = v30.cvssData.baseSeverity?.toLowerCase() ?? cvssToSeverity(score);
    }

    onChange({
      ...entry,
      title: cveData.id || entry.vid,
      description: desc,
      riskScore: score,
      severity: sev,
      autoFilled: true,
    });
    setLookupStatus("found");
  }, [cveData]); // eslint-disable-line react-hooks/exhaustive-deps

  // Handle case where lookup returns null (not found in NVD)
  useEffect(() => {
    if (
      !isFetching &&
      cveData === null &&
      debouncedVid.length >= 9 &&
      !entry.autoFilled
    ) {
      setLookupStatus("not-found");
    }
  }, [isFetching, cveData, debouncedVid, entry.autoFilled]);

  // Lookup status indicator
  const StatusIcon = () => {
    if (lookupStatus === "loading") {
      return <Loader2 className="h-4 w-4 animate-spin text-violet-400" />;
    }
    if (lookupStatus === "found") {
      return <Check className="h-4 w-4 text-emerald-400" />;
    }
    if (lookupStatus === "not-found") {
      return <AlertTriangle className="h-4 w-4 text-amber-400" />;
    }
    return null;
  };

  return (
    <div
      className={cn(
        "rounded-lg border border-gray-700 bg-gray-900/50 p-3",
        compact ? "space-y-2" : "space-y-3",
      )}
    >
      {/* Row 1: CVE ID + Severity + CVSS + Remove */}
      <div className="flex items-center gap-2">
        {/* CVE ID */}
        <div className="relative flex-1">
          <Input
            value={entry.vid}
            onChange={(e) => handleVidChange(e.target.value)}
            placeholder="CVE-2024-XXXXX"
            className="border-gray-700 bg-gray-900 pr-8 font-mono text-sm text-white placeholder:text-gray-500"
          />
          <div className="absolute right-2.5 top-1/2 -translate-y-1/2">
            <StatusIcon />
          </div>
        </div>

        {/* Severity */}
        <Select
          value={entry.severity}
          onValueChange={(value) => onChange({ ...entry, severity: value })}
        >
          <SelectTrigger className="w-32 border-gray-700 bg-gray-900 text-sm text-white">
            <SelectValue placeholder="Severity" />
          </SelectTrigger>
          <SelectContent className="border-gray-700 bg-gray-900">
            {SEVERITY_OPTIONS.map((s) => (
              <SelectItem
                key={s.value}
                value={s.value}
                className="text-white hover:bg-gray-800"
              >
                {s.label}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>

        {/* CVSS Score */}
        <Input
          type="number"
          min={0}
          max={10}
          step={0.1}
          value={entry.riskScore || ""}
          onChange={(e) => {
            const score = parseFloat(e.target.value) || 0;
            onChange({
              ...entry,
              riskScore: Math.min(10, Math.max(0, score)),
              severity: cvssToSeverity(score),
            });
          }}
          placeholder="CVSS"
          className="w-20 border-gray-700 bg-gray-900 text-center text-sm text-white placeholder:text-gray-500"
        />

        {/* Remove button */}
        <button
          type="button"
          onClick={onRemove}
          className="rounded p-2 text-gray-400 hover:bg-gray-700 hover:text-red-400"
        >
          <Trash2 className="h-4 w-4" />
        </button>
      </div>

      {/* Lookup feedback */}
      {lookupStatus === "found" && (
        <p className="text-xs text-emerald-400/80">
          Found: {entry.title || entry.vid}
        </p>
      )}
      {lookupStatus === "not-found" && (
        <p className="text-xs text-amber-400/80">
          Not in NVD — will use provided details
        </p>
      )}

      {/* Description (collapsible in compact mode) */}
      {!compact && (
        <textarea
          value={entry.description}
          onChange={(e) => onChange({ ...entry, description: e.target.value })}
          placeholder="Vulnerability description..."
          rows={2}
          className="w-full rounded-lg border border-gray-700 bg-gray-900 p-2.5 text-sm text-white placeholder:text-gray-500 focus:border-violet-500 focus:outline-none focus:ring-1 focus:ring-violet-500"
        />
      )}
    </div>
  );
};
