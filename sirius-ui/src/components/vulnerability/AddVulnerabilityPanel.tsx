/**
 * AddVulnerabilityPanel â€” slide-over wizard for manually adding
 * vulnerabilities to hosts.
 *
 * Three-step flow:
 *   1. Vulnerability Details (CVE ID, severity, CVSS, description)
 *   2. Select Target Host(s) (with inline host creation)
 *   3. Review & Submit
 *
 * Calls `addVulnerabilityToHost` tRPC mutation on submit, which hits
 * POST /host/with-source with manual source attribution.
 */

import React, { useState, useCallback, useMemo } from "react";
import {
  X,
  ChevronRight,
  ChevronLeft,
  Plus,
  Shield,
  Server,
  Check,
  Loader2,
  ArrowLeft,
} from "lucide-react";
import { cn } from "~/components/lib/utils";
import { api } from "~/utils/api";
import { toast } from "sonner";
import { Button } from "~/components/lib/ui/button";
import { Input } from "~/components/lib/ui/input";
import { Label } from "~/components/lib/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "~/components/lib/ui/select";

import {
  VulnerabilityEntryRow,
  generateEntryId,
  type VulnEntryData,
} from "~/components/shared/VulnerabilityEntryRow";
import {
  HostSelector,
  type SelectedHost,
} from "~/components/shared/HostSelector";
import { SeverityBadge } from "~/components/shared/SeverityBadge";

/* ------------------------------------------------------------------ */
/*  Types                                                              */
/* ------------------------------------------------------------------ */

interface AddVulnerabilityPanelProps {
  isOpen: boolean;
  onClose: () => void;
  /** If provided, skip host selection and pre-select this host */
  preselectedHostIp?: string;
  /** Called after successful submission */
  onSuccess?: () => void;
}

type WizardStep = "details" | "hosts" | "review";
type SubView = "main" | "create-host";

/* ------------------------------------------------------------------ */
/*  Inline host creation form (minimal)                                */
/* ------------------------------------------------------------------ */

const COMMON_OS = [
  "Linux",
  "Windows",
  "macOS",
  "FreeBSD",
  "Ubuntu",
  "CentOS",
  "Debian",
  "Red Hat",
  "Windows Server",
  "Other",
] as const;

const IP_REGEX =
  /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;

interface InlineHostFormProps {
  onBack: () => void;
  onCreated: (host: SelectedHost) => void;
}

const InlineHostForm: React.FC<InlineHostFormProps> = ({
  onBack,
  onCreated,
}) => {
  const [ip, setIp] = useState("");
  const [hostname, setHostname] = useState("");
  const [os, setOs] = useState("");
  const [osversion, setOsversion] = useState("");
  const [error, setError] = useState("");

  const utils = api.useContext();
  const createHost = api.host.createHost.useMutation({
    onSuccess: () => {
      toast.success(`Host ${ip} created`);
      void utils.host.getHostList.invalidate();
      void utils.host.getAllHosts.invalidate();
      onCreated({ ip, hostname });
    },
    onError: (err) => {
      toast.error(`Failed to create host: ${err.message}`);
    },
  });

  const handleCreate = () => {
    if (!ip.trim()) {
      setError("IP address is required");
      return;
    }
    if (!IP_REGEX.test(ip.trim())) {
      setError("Invalid IPv4 address");
      return;
    }
    setError("");
    createHost.mutate({
      ip: ip.trim(),
      hostname: hostname.trim() || undefined,
      os: os.trim() || undefined,
      osversion: osversion.trim() || undefined,
    });
  };

  return (
    <div className="space-y-4">
      <button
        onClick={onBack}
        className="flex items-center gap-1.5 text-sm text-gray-400 hover:text-gray-200"
      >
        <ArrowLeft className="h-4 w-4" />
        Back to host selection
      </button>

      <h3 className="text-sm font-semibold text-white">Create New Host</h3>

      <div className="space-y-3">
        <div>
          <Label className="text-xs text-gray-400">
            IP Address <span className="text-red-400">*</span>
          </Label>
          <Input
            value={ip}
            onChange={(e) => setIp(e.target.value)}
            placeholder="192.168.1.100"
            className="mt-1 border-gray-700 bg-gray-900 font-mono text-sm text-white placeholder:text-gray-500"
            autoFocus
          />
          {error && <p className="mt-1 text-xs text-red-400">{error}</p>}
        </div>
        <div>
          <Label className="text-xs text-gray-400">Hostname</Label>
          <Input
            value={hostname}
            onChange={(e) => setHostname(e.target.value)}
            placeholder="web-server-01"
            className="mt-1 border-gray-700 bg-gray-900 text-sm text-white placeholder:text-gray-500"
          />
        </div>
        <div className="flex gap-2">
          <div className="flex-1">
            <Label className="text-xs text-gray-400">OS</Label>
            <Select value={os} onValueChange={setOs}>
              <SelectTrigger className="mt-1 border-gray-700 bg-gray-900 text-sm text-white">
                <SelectValue placeholder="Select OS" />
              </SelectTrigger>
              <SelectContent className="border-gray-700 bg-gray-900">
                {COMMON_OS.map((o) => (
                  <SelectItem
                    key={o}
                    value={o}
                    className="text-white hover:bg-gray-800"
                  >
                    {o}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          <div className="flex-1">
            <Label className="text-xs text-gray-400">Version</Label>
            <Input
              value={osversion}
              onChange={(e) => setOsversion(e.target.value)}
              placeholder="22.04"
              className="mt-1 border-gray-700 bg-gray-900 text-sm text-white placeholder:text-gray-500"
            />
          </div>
        </div>
      </div>

      <Button
        variant="primary"
        onClick={handleCreate}
        disabled={createHost.isPending}
        className="w-full"
      >
        {createHost.isPending ? (
          <>
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            Creating...
          </>
        ) : (
          <>
            <Plus className="mr-2 h-4 w-4" />
            Create Host
          </>
        )}
      </Button>
    </div>
  );
};

/* ------------------------------------------------------------------ */
/*  Step indicators                                                    */
/* ------------------------------------------------------------------ */

const STEPS: { id: WizardStep; label: string; num: number }[] = [
  { id: "details", label: "Vulnerability Details", num: 1 },
  { id: "hosts", label: "Select Hosts", num: 2 },
  { id: "review", label: "Review & Submit", num: 3 },
];

/* ------------------------------------------------------------------ */
/*  Main Panel                                                         */
/* ------------------------------------------------------------------ */

export const AddVulnerabilityPanel: React.FC<AddVulnerabilityPanelProps> = ({
  isOpen,
  onClose,
  preselectedHostIp,
  onSuccess,
}) => {
  const [step, setStep] = useState<WizardStep>("details");
  const [subView, setSubView] = useState<SubView>("main");

  // Step 1: Vulnerability entries
  const [vulnEntries, setVulnEntries] = useState<VulnEntryData[]>([
    {
      id: generateEntryId(),
      vid: "",
      title: "",
      description: "",
      severity: "medium",
      riskScore: 0,
      autoFilled: false,
    },
  ]);

  // Step 2: Selected hosts
  const [selectedHosts, setSelectedHosts] = useState<SelectedHost[]>(() => {
    if (preselectedHostIp) {
      return [{ ip: preselectedHostIp, hostname: "" }];
    }
    return [];
  });

  // API
  const utils = api.useContext();
  const addVulnMutation = api.vulnerability.addVulnerabilityToHost.useMutation({
    onSuccess: () => {
      toast.success("Vulnerabilities added successfully");
      void utils.vulnerability.getAllVulnerabilities.invalidate();
      void utils.host.getAllHosts.invalidate();
      void utils.host.getHostList.invalidate();
      onSuccess?.();
      handleClose();
    },
    onError: (err) => {
      toast.error(`Failed to add vulnerabilities: ${err.message}`);
    },
  });

  // Handlers
  const handleClose = useCallback(() => {
    setStep("details");
    setSubView("main");
    setVulnEntries([
      {
        id: generateEntryId(),
        vid: "",
        title: "",
        description: "",
        severity: "medium",
        riskScore: 0,
        autoFilled: false,
      },
    ]);
    setSelectedHosts(
      preselectedHostIp ? [{ ip: preselectedHostIp, hostname: "" }] : [],
    );
    onClose();
  }, [onClose, preselectedHostIp]);

  const addVulnEntry = () => {
    setVulnEntries((prev) => [
      ...prev,
      {
        id: generateEntryId(),
        vid: "",
        title: "",
        description: "",
        severity: "medium",
        riskScore: 0,
        autoFilled: false,
      },
    ]);
  };

  const updateVulnEntry = (updated: VulnEntryData) => {
    setVulnEntries((prev) =>
      prev.map((e) => (e.id === updated.id ? updated : e)),
    );
  };

  const removeVulnEntry = (id: string) => {
    setVulnEntries((prev) => {
      if (prev.length <= 1) return prev; // keep at least one
      return prev.filter((e) => e.id !== id);
    });
  };

  // Validation
  const validVulns = useMemo(
    () => vulnEntries.filter((v) => v.vid.trim().length > 0),
    [vulnEntries],
  );

  const canProceedFromDetails = validVulns.length > 0;
  const canProceedFromHosts = selectedHosts.length > 0;

  // Navigate between steps
  const goNext = () => {
    if (step === "details" && canProceedFromDetails) {
      // Skip host step if preselected
      if (preselectedHostIp) {
        setStep("review");
      } else {
        setStep("hosts");
      }
    } else if (step === "hosts" && canProceedFromHosts) {
      setStep("review");
    }
  };

  const goBack = () => {
    if (step === "hosts") {
      setStep("details");
    } else if (step === "review") {
      if (preselectedHostIp) {
        setStep("details");
      } else {
        setStep("hosts");
      }
    }
  };

  // Submit
  const handleSubmit = async () => {
    const vulns = validVulns.map((v) => ({
      vid: v.vid.trim(),
      title: v.title || undefined,
      description: v.description,
      riskScore: v.riskScore,
    }));

    // Submit for each selected host
    for (const host of selectedHosts) {
      addVulnMutation.mutate({
        hostIp: host.ip,
        hostname: host.hostname || undefined,
        vulnerabilities: vulns,
      });
    }
  };

  // Handle inline host creation
  const handleHostCreated = (host: SelectedHost) => {
    setSelectedHosts((prev) => [...prev, host]);
    setSubView("main");
  };

  if (!isOpen) return null;

  return (
    <>
      {/* Backdrop */}
      <div
        className="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm"
        onClick={handleClose}
      />

      {/* Panel */}
      <div className="fixed bottom-0 right-0 top-0 z-50 flex w-full max-w-lg flex-col border-l border-gray-700 bg-gray-900 shadow-2xl">
        {/* Header */}
        <div className="flex items-center justify-between border-b border-gray-700 px-6 py-4">
          <div className="flex items-center gap-3">
            <div className="flex h-9 w-9 items-center justify-center rounded-lg bg-violet-500/10 ring-1 ring-violet-500/30">
              <Shield className="h-5 w-5 text-violet-400" />
            </div>
            <div>
              <h2 className="text-lg font-semibold text-white">
                Add Vulnerability
              </h2>
              <p className="text-xs text-gray-400">
                Manually add vulnerabilities to your environment
              </p>
            </div>
          </div>
          <button
            onClick={handleClose}
            className="rounded-lg p-2 text-gray-400 hover:bg-gray-800 hover:text-gray-200"
          >
            <X className="h-5 w-5" />
          </button>
        </div>

        {/* Step indicator */}
        <div className="flex items-center gap-2 border-b border-gray-800 px-6 py-3">
          {STEPS.map((s, i) => {
            const active = s.id === step;
            const done =
              (s.id === "details" &&
                (step === "hosts" || step === "review")) ||
              (s.id === "hosts" && step === "review");
            return (
              <React.Fragment key={s.id}>
                {i > 0 && (
                  <ChevronRight className="h-3.5 w-3.5 text-gray-600" />
                )}
                <div
                  className={cn(
                    "flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-medium transition-colors",
                    active
                      ? "bg-violet-500/20 text-violet-300 ring-1 ring-violet-500/30"
                      : done
                      ? "text-emerald-400"
                      : "text-gray-500",
                  )}
                >
                  {done ? (
                    <Check className="h-3 w-3" />
                  ) : (
                    <span className="flex h-4 w-4 items-center justify-center rounded-full bg-gray-800 text-[10px]">
                      {s.num}
                    </span>
                  )}
                  <span className="hidden sm:inline">{s.label}</span>
                </div>
              </React.Fragment>
            );
          })}
        </div>

        {/* Content (scrollable) */}
        <div className="flex-1 overflow-y-auto px-6 py-5">
          {/* ---- Step 1: Vulnerability Details ---- */}
          {step === "details" && (
            <div className="space-y-4">
              <div className="flex items-center justify-between">
                <h3 className="text-sm font-semibold text-gray-300">
                  Vulnerability Details
                </h3>
                <span className="text-xs text-gray-500">
                  {validVulns.length} entr{validVulns.length === 1 ? "y" : "ies"}
                </span>
              </div>

              <p className="text-xs text-gray-500">
                Enter a CVE ID to auto-fill details from the NVD, or provide
                information manually.
              </p>

              <div className="space-y-3">
                {vulnEntries.map((entry, i) => (
                  <VulnerabilityEntryRow
                    key={entry.id}
                    entry={entry}
                    onChange={updateVulnEntry}
                    onRemove={() => removeVulnEntry(entry.id)}
                    index={i}
                  />
                ))}
              </div>

              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={addVulnEntry}
                className="border-dashed border-gray-600 text-gray-400 hover:border-violet-500 hover:text-violet-400"
              >
                <Plus className="mr-1 h-4 w-4" />
                Add Another Vulnerability
              </Button>
            </div>
          )}

          {/* ---- Step 2: Select Hosts ---- */}
          {step === "hosts" && (
            <div className="space-y-4">
              {subView === "main" ? (
                <>
                  <h3 className="text-sm font-semibold text-gray-300">
                    Select Target Host(s)
                  </h3>
                  <p className="text-xs text-gray-500">
                    Choose which host(s) to associate these vulnerabilities with.
                    If the host doesn&apos;t exist yet, create one inline.
                  </p>
                  <HostSelector
                    selected={selectedHosts}
                    onChange={setSelectedHosts}
                    onCreateHost={() => setSubView("create-host")}
                  />
                </>
              ) : (
                <InlineHostForm
                  onBack={() => setSubView("main")}
                  onCreated={handleHostCreated}
                />
              )}
            </div>
          )}

          {/* ---- Step 3: Review ---- */}
          {step === "review" && (
            <div className="space-y-5">
              <h3 className="text-sm font-semibold text-gray-300">
                Review & Submit
              </h3>

              {/* Vulnerabilities summary */}
              <div className="rounded-lg border border-gray-700 bg-gray-800/50 p-4">
                <div className="mb-3 flex items-center gap-2 text-xs font-medium uppercase tracking-wider text-gray-400">
                  <Shield className="h-3.5 w-3.5" />
                  Vulnerabilities ({validVulns.length})
                </div>
                <div className="space-y-2">
                  {validVulns.map((v) => (
                    <div
                      key={v.id}
                      className="flex items-center gap-3 rounded-lg bg-gray-900/50 px-3 py-2"
                    >
                      <SeverityBadge severity={v.severity} />
                      <span className="flex-1 truncate font-mono text-sm text-white">
                        {v.vid}
                      </span>
                      <span className="text-xs text-gray-500">
                        CVSS {v.riskScore.toFixed(1)}
                      </span>
                    </div>
                  ))}
                </div>
              </div>

              {/* Hosts summary */}
              <div className="rounded-lg border border-gray-700 bg-gray-800/50 p-4">
                <div className="mb-3 flex items-center gap-2 text-xs font-medium uppercase tracking-wider text-gray-400">
                  <Server className="h-3.5 w-3.5" />
                  Target Hosts ({selectedHosts.length})
                </div>
                <div className="space-y-2">
                  {selectedHosts.map((h) => (
                    <div
                      key={h.ip}
                      className="flex items-center gap-3 rounded-lg bg-gray-900/50 px-3 py-2"
                    >
                      <Server className="h-4 w-4 text-violet-400" />
                      <span className="font-mono text-sm text-white">
                        {h.ip}
                      </span>
                      {h.hostname && (
                        <span className="text-xs text-gray-500">
                          {h.hostname}
                        </span>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {/* Source attribution note */}
              <div className="rounded-lg border border-purple-500/20 bg-purple-500/5 px-4 py-3">
                <p className="text-xs text-purple-300">
                  These vulnerabilities will be attributed to the{" "}
                  <span className="font-semibold">Manual</span> source and will
                  appear with a purple badge throughout the system.
                </p>
              </div>
            </div>
          )}
        </div>

        {/* Footer with navigation */}
        <div className="flex items-center justify-between border-t border-gray-700 px-6 py-4">
          <div>
            {step !== "details" && (
              <Button variant="outline" onClick={goBack}>
                <ChevronLeft className="mr-1 h-4 w-4" />
                Back
              </Button>
            )}
          </div>

          <div className="flex items-center gap-3">
            <Button variant="outline" onClick={handleClose}>
              Cancel
            </Button>

            {step === "review" ? (
              <Button
                variant="primary"
                onClick={handleSubmit}
                disabled={addVulnMutation.isPending}
              >
                {addVulnMutation.isPending ? (
                  <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Submitting...
                  </>
                ) : (
                  <>
                    <Check className="mr-2 h-4 w-4" />
                    Submit
                  </>
                )}
              </Button>
            ) : (
              <Button
                variant="primary"
                onClick={goNext}
                disabled={
                  (step === "details" && !canProceedFromDetails) ||
                  (step === "hosts" && !canProceedFromHosts)
                }
              >
                Next
                <ChevronRight className="ml-1 h-4 w-4" />
              </Button>
            )}
          </div>
        </div>
      </div>
    </>
  );
};
