/**
 * VulnColumns.tsx — Consolidated, v0.4 dark-only column definitions.
 *
 * Exports:
 *   vulnColumns        – base columns (severity, CVE, score, description, actions)
 *   vulnColumnsWithSources – extended columns adding source attribution, confidence, first/last seen
 *
 * Re-exports types and filter config so consumers can import from a single module.
 */

"use client";

import React, { useState } from "react";
import { useRouter } from "next/router";
import { type ColumnDef } from "@tanstack/react-table";
import { type SourceAttribution } from "~/types/scanTypes";
import { ExternalLink, Eye, Clock, Shield } from "lucide-react";
import { cn } from "~/components/lib/utils";
import { SeverityBadge } from "~/components/shared/SeverityBadge";
import { SourceBadge } from "~/components/shared/SourceBadge";
import { CvssScore } from "~/components/shared/CvssScore";
import { timeAgo, getConfidenceColor } from "~/utils/formatters";

/* ------------------------------------------------------------------ */
/*  Types (re-exported so callers need only one import)                 */
/* ------------------------------------------------------------------ */

export interface VulnTableData {
  cve: string;
  title?: string;
  severity: "CRITICAL" | "HIGH" | "MEDIUM" | "LOW" | "INFORMATIONAL";
  description: string;
  riskScore: number;
  references: string[];
  affectedHosts: string[];
  sources?: string[];
  selected?: boolean;
  [key: string]: any;
}

export interface VulnTableDataWithSources extends VulnTableData {
  sources: SourceAttribution[];
  port?: number;
  service_info?: string;
  first_detected?: string;
  last_confirmed?: string;
  confidence_score?: number;
}

/* ------------------------------------------------------------------ */
/*  Helpers                                                            */
/* ------------------------------------------------------------------ */

/** Severity weight for sorting — higher = more severe. */
const SEVERITY_WEIGHT: Record<string, number> = {
  CRITICAL: 5,
  HIGH: 4,
  MEDIUM: 3,
  LOW: 2,
  INFORMATIONAL: 1,
};

/** Action buttons cell — navigates to the vulnerability detail page. */
function VulnActionButtons({ cve }: { cve: string }) {
  const router = useRouter();
  return (
    <div className="flex justify-end gap-1">
      <button
        onClick={(e) => {
          e.stopPropagation();
          void router.push(`/vulnerability?id=${encodeURIComponent(cve)}`);
        }}
        className="rounded p-1 text-gray-500 hover:bg-gray-800 hover:text-violet-400"
        title="View vulnerability details"
      >
        <Eye className="h-3.5 w-3.5" />
      </button>
      <a
        href={`https://nvd.nist.gov/vuln/detail/${cve}`}
        target="_blank"
        rel="noopener noreferrer"
        className="rounded p-1 text-gray-500 hover:bg-gray-800 hover:text-blue-400"
        title="View in NVD database"
        onClick={(e) => e.stopPropagation()}
      >
        <ExternalLink className="h-3.5 w-3.5" />
      </a>
    </div>
  );
}

/** Expandable description cell — shows "Show more" for long text. */
function ExpandableDescription({ text, maxWidth = "500px" }: { text: string; maxWidth?: string }) {
  const [expanded, setExpanded] = useState(false);
  return (
    <div className={cn("text-xs text-gray-300")} style={{ maxWidth }}>
      <div className={cn(!expanded && "line-clamp-1")}>{text}</div>
      {text.length > 100 && (
        <button
          onClick={(e) => {
            e.stopPropagation();
            setExpanded((p) => !p);
          }}
          className="mt-0.5 text-xs text-violet-400 hover:text-violet-300"
        >
          {expanded ? "Show less" : "Show more"}
        </button>
      )}
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Base columns                                                       */
/* ------------------------------------------------------------------ */

export const vulnColumns: ColumnDef<VulnTableData, any>[] = [
  {
    accessorKey: "severity",
    header: "Severity",
    cell: ({ row }) => (
      <SeverityBadge severity={row.getValue("severity")} variant="scanner" />
    ),
    filterFn: (row, id, value) => {
      return value.includes(row.getValue(id));
    },
    sortingFn: (rowA, rowB) => {
      const a = SEVERITY_WEIGHT[rowA.getValue<string>("severity")] ?? 0;
      const b = SEVERITY_WEIGHT[rowB.getValue<string>("severity")] ?? 0;
      return a - b;
    },
  },
  {
    accessorKey: "cve",
    header: "CVE ID",
    cell: ({ row }) => (
      <span className="font-mono text-xs font-medium text-gray-200">
        {row.getValue("cve")}
      </span>
    ),
  },
  {
    accessorKey: "riskScore",
    header: "CVSS",
    cell: ({ row }) => (
      <CvssScore score={parseFloat(row.getValue("riskScore"))} />
    ),
  },
  {
    accessorKey: "description",
    header: "Description",
    cell: ({ row }) => (
      <ExpandableDescription text={row.getValue("description")} />
    ),
  },
  {
    id: "actions",
    cell: ({ row }) => <VulnActionButtons cve={row.getValue("cve") as string} />,
  },
];

/* ------------------------------------------------------------------ */
/*  Extended columns with source attribution                           */
/* ------------------------------------------------------------------ */

export const vulnColumnsWithSources: ColumnDef<VulnTableDataWithSources, any>[] = [
  // Severity
  {
    accessorKey: "severity",
    header: "Severity",
    cell: ({ row }) => (
      <SeverityBadge severity={row.getValue("severity")} variant="scanner" />
    ),
    filterFn: (row, id, value) => {
      return value.includes(row.getValue(id));
    },
    sortingFn: (rowA, rowB) => {
      const a = SEVERITY_WEIGHT[rowA.getValue<string>("severity")] ?? 0;
      const b = SEVERITY_WEIGHT[rowB.getValue<string>("severity")] ?? 0;
      return a - b;
    },
  },
  // CVE
  {
    accessorKey: "cve",
    header: "CVE ID",
    cell: ({ row }) => (
      <span className="font-mono text-xs font-medium text-gray-200">
        {row.getValue("cve")}
      </span>
    ),
  },
  // Sources
  {
    accessorKey: "sources",
    header: "Sources",
    cell: ({ row }) => {
      const sources = row.getValue("sources") as SourceAttribution[];
      if (!sources || sources.length === 0) {
        return <span className="text-xs text-gray-500">Unknown</span>;
      }
      return (
        <div className="flex flex-wrap gap-1">
          {sources.slice(0, 2).map((source, index) => (
            <SourceBadge key={index} source={source.source} />
          ))}
          {sources.length > 2 && (
            <span className="text-xs text-gray-500">+{sources.length - 2}</span>
          )}
        </div>
      );
    },
    filterFn: (row, id, value) => {
      const sources = row.getValue(id) as SourceAttribution[];
      if (!sources) return false;
      return sources.some((source) => value.includes(source.source));
    },
  },
  // Confidence
  {
    accessorKey: "confidence_score",
    header: "Confidence",
    cell: ({ row }) => {
      const sources = row.getValue("sources") as SourceAttribution[];
      if (!sources || sources.length === 0) return null;
      const avgConfidence =
        sources.reduce((sum, s) => sum + s.confidence, 0) / sources.length;
      return (
        <div className="flex items-center gap-1">
          <Shield className="h-3 w-3" />
          <span className={`text-xs font-medium ${getConfidenceColor(avgConfidence)}`}>
            {(avgConfidence * 100).toFixed(0)}%
          </span>
        </div>
      );
    },
    sortingFn: (rowA, rowB) => {
      const sa = rowA.getValue("sources") as SourceAttribution[];
      const sb = rowB.getValue("sources") as SourceAttribution[];
      const avgA = sa?.length ? sa.reduce((s, x) => s + x.confidence, 0) / sa.length : 0;
      const avgB = sb?.length ? sb.reduce((s, x) => s + x.confidence, 0) / sb.length : 0;
      return avgA - avgB;
    },
  },
  // First seen
  {
    accessorKey: "first_detected",
    header: "First Seen",
    cell: ({ row }) => {
      const sources = row.getValue("sources") as SourceAttribution[];
      if (!sources || sources.length === 0) return null;
      const earliest = sources.reduce((e, s) => {
        const d = new Date(s.first_seen);
        return d < e ? d : e;
      }, new Date(sources[0]!.first_seen));
      return (
        <div className="flex items-center gap-1 text-xs text-gray-400">
          <Clock className="h-3 w-3" />
          {timeAgo(earliest.toISOString())}
        </div>
      );
    },
    sortingFn: (rowA, rowB) => {
      const sa = rowA.getValue("sources") as SourceAttribution[];
      const sb = rowB.getValue("sources") as SourceAttribution[];
      if (!sa?.length || !sb?.length) return 0;
      const ea = sa.reduce((e, s) => { const d = new Date(s.first_seen); return d < e ? d : e; }, new Date(sa[0]!.first_seen));
      const eb = sb.reduce((e, s) => { const d = new Date(s.first_seen); return d < e ? d : e; }, new Date(sb[0]!.first_seen));
      return ea.getTime() - eb.getTime();
    },
  },
  // Last seen
  {
    accessorKey: "last_confirmed",
    header: "Last Seen",
    cell: ({ row }) => {
      const sources = row.getValue("sources") as SourceAttribution[];
      if (!sources || sources.length === 0) return null;
      const latest = sources.reduce((l, s) => {
        const d = new Date(s.last_seen);
        return d > l ? d : l;
      }, new Date(sources[0]!.last_seen));
      return (
        <div className="flex items-center gap-1 text-xs text-gray-400">
          <Clock className="h-3 w-3" />
          {timeAgo(latest.toISOString())}
        </div>
      );
    },
    sortingFn: (rowA, rowB) => {
      const sa = rowA.getValue("sources") as SourceAttribution[];
      const sb = rowB.getValue("sources") as SourceAttribution[];
      if (!sa?.length || !sb?.length) return 0;
      const la = sa.reduce((l, s) => { const d = new Date(s.last_seen); return d > l ? d : l; }, new Date(sa[0]!.last_seen));
      const lb = sb.reduce((l, s) => { const d = new Date(s.last_seen); return d > l ? d : l; }, new Date(sb[0]!.last_seen));
      return la.getTime() - lb.getTime();
    },
  },
  // CVSS
  {
    accessorKey: "riskScore",
    header: "CVSS",
    cell: ({ row }) => (
      <CvssScore score={parseFloat(row.getValue("riskScore"))} />
    ),
  },
  // Description
  {
    accessorKey: "description",
    header: "Description",
    cell: ({ row }) => (
      <ExpandableDescription text={row.getValue("description")} maxWidth="400px" />
    ),
  },
  // Actions
  {
    id: "actions",
    cell: ({ row }) => <VulnActionButtons cve={row.getValue("cve") as string} />,
  },
];

/* ------------------------------------------------------------------ */
/*  Filter config (re-exported for consumers)                          */
/* ------------------------------------------------------------------ */

export const sourceFilterOptions = [
  { value: "nmap", label: "Nmap", color: "blue" },
  { value: "agent", label: "Agent", color: "green" },
  { value: "rustscan", label: "RustScan", color: "orange" },
  { value: "manual", label: "Manual", color: "purple" },
  { value: "naabu", label: "Naabu", color: "cyan" },
];

export const confidenceFilterOptions = [
  { value: "high", label: "High (90%+)", min: 0.9, max: 1.0 },
  { value: "medium", label: "Medium (70-89%)", min: 0.7, max: 0.89 },
  { value: "low", label: "Low (<70%)", min: 0.0, max: 0.69 },
];
