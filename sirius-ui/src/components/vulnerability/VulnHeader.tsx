/**
 * VulnHeader — v4 sticky header following the standard pattern used by
 * Dashboard, Host Detail, Scanner, and Console pages.
 *
 * sticky top-2 · glassmorphism · icon container with ring · 2xl bold title
 */

import React from "react";
import { useRouter } from "next/router";
import {
  Shield,
  ExternalLink,
  Printer,
  ChevronRight,
  Calendar,
} from "lucide-react";
import { getSeverityColors } from "~/utils/severityTheme";
import type { VulnPageData } from "./types";

interface VulnHeaderProps {
  data: VulnPageData;
}

export const VulnHeader: React.FC<VulnHeaderProps> = ({ data }) => {
  const router = useRouter();
  const sevColors = getSeverityColors(data.severity);

  const formatDate = (iso: string) => {
    if (!iso) return "";
    try {
      return new Date(iso).toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
      });
    } catch {
      return iso;
    }
  };

  return (
    <div className="sticky top-2 z-30 -mx-4 border-b border-violet-500/20 bg-gray-900/95 px-4 py-3 shadow-lg shadow-black/20 backdrop-blur-sm md:-mx-6 md:px-6">
      <div className="flex items-center gap-3">
        {/* Standard v4 icon container */}
        <div className="flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-violet-500/10 ring-2 ring-violet-500/20">
          <Shield className="h-6 w-6 text-violet-400" />
        </div>

        {/* Title area with inline breadcrumb */}
        <div className="min-w-0">
          <div className="flex items-center gap-2">
            <button
              onClick={() => void router.push("/vulnerabilities")}
              className="shrink-0 text-sm text-gray-500 transition-colors hover:text-violet-400"
            >
              Vulnerabilities
            </button>
            <ChevronRight className="h-3.5 w-3.5 shrink-0 text-gray-600" />
            <h1 className="truncate text-2xl font-bold tracking-tight text-white">
              {data.cve.id || "CVE"}
            </h1>
          </div>

          {/* Metadata row */}
          <div className="mt-0.5 flex items-center gap-2 text-xs text-gray-400">
            {/* Severity badge */}
            <span
              className={`rounded-full px-2 py-0.5 text-[10px] font-semibold uppercase ${sevColors.bg} ${sevColors.text}`}
            >
              {data.severity}
            </span>

            {/* CVSS score pill */}
            {data.cvssScore > 0 && (
              <span className="rounded border border-violet-500/10 bg-gray-900/50 px-1.5 py-0.5 font-mono text-[10px] font-medium text-gray-300">
                CVSS {data.cvssScore.toFixed(1)}
              </span>
            )}

            {/* Published date */}
            {data.cve.published && (
              <span className="flex items-center gap-1 text-[10px] text-gray-500">
                <Calendar className="h-3 w-3" />
                {formatDate(data.cve.published)}
              </span>
            )}

            {/* Status */}
            {data.cve.vulnStatus && (
              <span className="rounded-full bg-gray-800/80 px-2 py-0.5 text-[10px] font-medium text-gray-400">
                {data.cve.vulnStatus}
              </span>
            )}
          </div>
        </div>

        {/* Spacer */}
        <div className="flex-1" />

        {/* Actions (right side) */}
        <div className="flex shrink-0 items-center gap-2 pr-14">
          <a
            href={`https://nvd.nist.gov/vuln/detail/${data.cve.id}`}
            target="_blank"
            rel="noopener noreferrer"
            className="flex items-center gap-1.5 rounded-md border border-violet-500/20 bg-violet-500/10 px-3 py-1.5 text-xs font-medium text-violet-300 transition-colors hover:border-violet-500/30 hover:bg-violet-500/20"
          >
            <ExternalLink className="h-3.5 w-3.5" />
            View in NVD
          </a>
          <button
            className="flex items-center gap-1.5 rounded-md border border-violet-500/10 px-3 py-1.5 text-xs font-medium text-gray-400 transition-colors hover:border-violet-500/20 hover:text-gray-300"
            onClick={() => window.print()}
          >
            <Printer className="h-3.5 w-3.5" />
            Print Report
          </button>
        </div>
      </div>
    </div>
  );
};

export default VulnHeader;
