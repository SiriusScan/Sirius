/**
 * VulnMetrics — Visual hero section for the Vulnerability Detail page.
 *
 * Asymmetric 2-column layout:
 *   Left  (1/3): SVG radial CVSS gauge with severity-colored arc
 *   Right (2/3): Attack Surface chips + CIA Impact color-blocks
 * Below: optional vendor info strip
 */

import React from "react";
import { Package } from "lucide-react";
import {
  getSeverityColors,
  getSeverityHex,
  getCvssTextColor,
} from "~/utils/severityTheme";
import type { VulnPageData } from "./types";

/* ------------------------------------------------------------------ */
/*  Props                                                              */
/* ------------------------------------------------------------------ */

interface VulnMetricsProps {
  data: VulnPageData;
}

/* ------------------------------------------------------------------ */
/*  Attack-chip risk color mapping                                     */
/* ------------------------------------------------------------------ */

function getAttackRiskColor(metric: string, value: string): string {
  const v = value.toUpperCase();
  switch (metric) {
    case "attackVector":
      if (v === "NETWORK") return "bg-red-500";
      if (v === "ADJACENT_NETWORK") return "bg-orange-500";
      if (v === "LOCAL") return "bg-amber-500";
      return "bg-green-500"; // PHYSICAL
    case "attackComplexity":
      return v === "LOW" ? "bg-red-500" : "bg-green-500";
    case "privilegesRequired":
      if (v === "NONE") return "bg-red-500";
      if (v === "LOW") return "bg-amber-500";
      return "bg-green-500"; // HIGH
    case "userInteraction":
      return v === "NONE" ? "bg-red-500" : "bg-green-500";
    default:
      return "bg-gray-500";
  }
}

/* ------------------------------------------------------------------ */
/*  CIA impact block color set                                         */
/* ------------------------------------------------------------------ */

interface CiaBlockColors {
  bg: string;
  border: string;
  ring: string;
  text: string;
}

function getCiaBlockColors(level: string): CiaBlockColors {
  switch (level.toUpperCase()) {
    case "HIGH":
      return {
        bg: "bg-red-500/10",
        border: "border-red-500/30",
        ring: "ring-red-500/20",
        text: "text-red-400",
      };
    case "LOW":
      return {
        bg: "bg-amber-500/10",
        border: "border-amber-500/30",
        ring: "ring-amber-500/20",
        text: "text-amber-400",
      };
    case "NONE":
      return {
        bg: "bg-green-500/10",
        border: "border-green-500/30",
        ring: "ring-green-500/20",
        text: "text-green-400",
      };
    default:
      return {
        bg: "bg-gray-500/10",
        border: "border-gray-500/30",
        ring: "ring-gray-500/20",
        text: "text-gray-400",
      };
  }
}

/* ------------------------------------------------------------------ */
/*  SVG Radial Gauge                                                   */
/* ------------------------------------------------------------------ */

const RADIUS = 62;
const STROKE_WIDTH = 12;
const SWEEP_FRACTION = 0.75; // 270° arc
const CIRCUMFERENCE = 2 * Math.PI * RADIUS * SWEEP_FRACTION;

const CvssGauge: React.FC<{ score: number; severity: string }> = ({
  score,
  severity,
}) => {
  const sevHex = getSeverityHex(severity);
  const sevColors = getSeverityColors(severity);
  const scoreColor = getCvssTextColor(score);
  const dashOffset = CIRCUMFERENCE - (score / 10) * CIRCUMFERENCE;

  return (
    <div className="relative flex flex-col items-center justify-center">
      {/* SVG gauge */}
      <svg
        viewBox="0 0 160 160"
        className="h-44 w-44"
        style={{
          filter: `drop-shadow(0 0 8px ${sevHex}40)`,
        }}
      >
        {/* Background track */}
        <circle
          cx="80"
          cy="80"
          r={RADIUS}
          fill="none"
          stroke="rgb(55, 65, 81)"
          strokeOpacity="0.3"
          strokeWidth={STROKE_WIDTH}
          strokeLinecap="round"
          strokeDasharray={CIRCUMFERENCE}
          strokeDashoffset="0"
          transform="rotate(-225, 80, 80)"
        />
        {/* Score arc */}
        <circle
          cx="80"
          cy="80"
          r={RADIUS}
          fill="none"
          stroke={sevHex}
          strokeWidth={STROKE_WIDTH}
          strokeLinecap="round"
          strokeDasharray={CIRCUMFERENCE}
          strokeDashoffset={dashOffset}
          transform="rotate(-225, 80, 80)"
          style={{
            transition: "stroke-dashoffset 1s ease-out",
          }}
        />
      </svg>

      {/* Centered content overlay */}
      <div className="absolute inset-0 flex flex-col items-center justify-center">
        <div className="flex items-baseline">
          <span
            className={`text-5xl font-bold tabular-nums ${scoreColor}`}
          >
            {score > 0 ? score.toFixed(1) : "—"}
          </span>
          <span className="ml-0.5 text-sm text-gray-600">/ 10</span>
        </div>
        <span
          className={`mt-1.5 rounded-full px-2.5 py-0.5 text-xs font-semibold uppercase ${sevColors.bg} ${sevColors.text}`}
        >
          {severity}
        </span>
      </div>
    </div>
  );
};

/* ------------------------------------------------------------------ */
/*  Attack Surface Chips                                               */
/* ------------------------------------------------------------------ */

const ATTACK_METRICS: Array<{
  key: "attackVector" | "attackComplexity" | "privilegesRequired" | "userInteraction";
  label: string;
}> = [
  { key: "attackVector", label: "Vector" },
  { key: "attackComplexity", label: "Complexity" },
  { key: "privilegesRequired", label: "Privileges" },
  { key: "userInteraction", label: "User Int." },
];

const AttackSurfaceCard: React.FC<{
  attackSurface: VulnPageData["attackSurface"];
}> = ({ attackSurface }) => (
  <div className="scanner-section flex flex-col gap-2 px-4 py-3">
    <div className="text-xs font-medium uppercase tracking-wider text-gray-500">
      Attack Surface
    </div>
    <div className="grid grid-cols-4 gap-1.5">
      {ATTACK_METRICS.map(({ key, label }) => {
        const value = attackSurface[key];
        const dotColor = getAttackRiskColor(key, value);
        return (
          <div
            key={key}
            className="rounded-lg border border-violet-500/10 bg-gray-900/30 px-2.5 py-1.5"
          >
            <div className="flex items-center gap-1.5">
              <div className={`h-2 w-2 shrink-0 rounded-full ${dotColor}`} />
              <span className="text-[10px] uppercase tracking-wider text-gray-500">
                {label}
              </span>
            </div>
            <div className="mt-0.5 truncate text-sm font-medium text-gray-200">
              {value}
            </div>
          </div>
        );
      })}
    </div>
  </div>
);

/* ------------------------------------------------------------------ */
/*  CIA Impact Blocks                                                  */
/* ------------------------------------------------------------------ */

const CIA_FIELDS: Array<{
  key: "confidentiality" | "integrity" | "availability";
  letter: string;
  fullName: string;
}> = [
  { key: "confidentiality", letter: "C", fullName: "Confidentiality" },
  { key: "integrity", letter: "I", fullName: "Integrity" },
  { key: "availability", letter: "A", fullName: "Availability" },
];

const CiaImpactCard: React.FC<{
  ciaImpact: VulnPageData["ciaImpact"];
}> = ({ ciaImpact }) => (
  <div className="scanner-section flex flex-col gap-2 px-4 py-3">
    <div className="text-xs font-medium uppercase tracking-wider text-gray-500">
      CIA Impact
    </div>
    <div className="grid grid-cols-3 gap-2">
      {CIA_FIELDS.map(({ key, letter, fullName }) => {
        const level = ciaImpact[key];
        const colors = getCiaBlockColors(level);
        return (
          <div
            key={key}
            className={`flex flex-col items-center justify-center rounded-lg border px-3 py-2.5 ring-1 ${colors.bg} ${colors.border} ${colors.ring}`}
          >
            <span className={`text-xl font-bold ${colors.text}`}>
              {letter}
            </span>
            <span className="mt-0.5 text-[10px] uppercase tracking-wider text-gray-500">
              {fullName}
            </span>
            <span className={`text-[11px] font-semibold ${colors.text}`}>
              {level}
            </span>
          </div>
        );
      })}
    </div>
  </div>
);

/* ------------------------------------------------------------------ */
/*  Main component                                                     */
/* ------------------------------------------------------------------ */

export const VulnMetrics: React.FC<VulnMetricsProps> = ({ data }) => {
  return (
    <div className="space-y-3">
      {/* ── Asymmetric hero layout ─────────────────────────────────── */}
      <div className="grid gap-3 lg:grid-cols-3">
        {/* Left: CVSS Gauge (1/3) */}
        <div className="scanner-section flex flex-col items-center justify-center gap-2 px-3 py-3 lg:col-span-1">
          <CvssGauge score={data.cvssScore} severity={data.severity} />
          {data.vectorString && (
            <span className="truncate font-mono text-[10px] text-gray-600">
              {data.vectorString}
            </span>
          )}
        </div>

        {/* Right: Stacked cards (2/3) */}
        <div className="flex flex-col gap-3 lg:col-span-2">
          <AttackSurfaceCard attackSurface={data.attackSurface} />
          <CiaImpactCard ciaImpact={data.ciaImpact} />
        </div>
      </div>

      {/* ── Vendor info strip ──────────────────────────────────────── */}
      {data.cpeInfo.vendor !== "Unknown" && (
        <div className="scanner-section px-4 py-2.5">
          <div className="flex items-center gap-3">
            <Package className="h-4 w-4 shrink-0 text-violet-400" />
            <span className="text-sm text-gray-300">
              {data.cpeInfo.vendor}{" "}
              <span className="text-gray-500">/</span>{" "}
              {data.cpeInfo.product}
            </span>
            {data.cpeInfo.version !== "*" && (
              <span className="text-sm text-gray-600">
                ≤ {data.cpeInfo.version}
              </span>
            )}
          </div>
          {data.productDescription && (
            <p className="mt-1.5 line-clamp-2 pl-7 text-xs leading-relaxed text-gray-500">
              {data.productDescription}
            </p>
          )}
        </div>
      )}
    </div>
  );
};

export default VulnMetrics;
