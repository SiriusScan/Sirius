/**
 * VulnNVDDetails — Extracted and modernized "NVD Details" tab content.
 *
 * Replaces the legacy raw HTML table with structured v4 card sections:
 *   - Identity & Status
 *   - Scoring
 *   - Configuration (CPE)
 *   - Timeline
 *   - Evaluator Notes
 *   - Weaknesses
 *   - References
 */

import React from "react";
import {
  Hash,
  BarChart3,
  Cpu,
  Calendar,
  MessageSquare,
  Bug,
  Link2,
  Info,
} from "lucide-react";
import type { CveItem } from "~/server/api/routers/vulnerability";

interface VulnNVDDetailsProps {
  cve: CveItem;
}

/* ------------------------------------------------------------------ */
/*  Small helpers                                                      */
/* ------------------------------------------------------------------ */

const Section: React.FC<{
  icon: React.ReactNode;
  title: string;
  children: React.ReactNode;
}> = ({ icon, title, children }) => (
  <div className="scanner-section scanner-section-padding">
    <div className="mb-4 flex items-center gap-2 text-xs font-medium uppercase tracking-wider text-gray-500">
      {icon}
      {title}
    </div>
    {children}
  </div>
);

const Row: React.FC<{ label: string; value: React.ReactNode }> = ({
  label,
  value,
}) => {
  if (!value || (typeof value === "string" && !value.trim())) return null;
  return (
    <div className="flex items-start gap-4 border-b border-violet-500/5 py-2 last:border-0">
      <span className="w-36 shrink-0 text-xs uppercase tracking-wider text-gray-500">
        {label}
      </span>
      <span className="text-sm text-gray-300">{value}</span>
    </div>
  );
};

const formatDate = (iso: string) => {
  if (!iso) return "";
  try {
    return new Date(iso).toLocaleString("en-US", {
      dateStyle: "medium",
      timeStyle: "short",
    });
  } catch {
    return iso;
  }
};

/* ------------------------------------------------------------------ */
/*  Component                                                          */
/* ------------------------------------------------------------------ */

export const VulnNVDDetails: React.FC<VulnNVDDetailsProps> = ({ cve }) => {
  const v31 = cve.metrics?.cvssMetricV31?.[0];
  const v30 = cve.metrics?.cvssMetricV30?.[0];
  const v2 = cve.metrics?.cvssMetricV2?.[0];
  const cvssData = v31?.cvssData ?? v30?.cvssData;

  return (
    <div className="space-y-6">
      {/* ── Identity & Status ────────────────────────────────────── */}
      <Section
        icon={<Hash className="h-4 w-4 text-violet-400" />}
        title="Identity & Status"
      >
        <div className="flex flex-col gap-0">
          <Row label="CVE ID" value={cve.id} />
          <Row label="Source" value={cve.sourceIdentifier} />
          <Row label="Status" value={cve.vulnStatus} />
          {cve.cveTags && cve.cveTags.length > 0 && (
            <Row
              label="Tags"
              value={
                <div className="flex flex-wrap gap-1">
                  {cve.cveTags.map((t) =>
                    t.tags.map((tag) => (
                      <span
                        key={`${t.sourceIdentifier}-${tag}`}
                        className="rounded bg-gray-800 px-1.5 py-0.5 text-[10px] text-gray-400"
                      >
                        {tag}
                      </span>
                    )),
                  )}
                </div>
              }
            />
          )}
        </div>
      </Section>

      {/* ── Scoring ──────────────────────────────────────────────── */}
      {cvssData && (
        <Section
          icon={<BarChart3 className="h-4 w-4 text-violet-400" />}
          title="Scoring"
        >
          <div className="flex flex-col gap-0">
            <Row label="CVSS Version" value={cvssData.version} />
            <Row
              label="Base Score"
              value={`${cvssData.baseScore} (${cvssData.baseSeverity})`}
            />
            <Row
              label="Vector String"
              value={
                <span className="font-mono text-xs text-gray-400">
                  {cvssData.vectorString}
                </span>
              }
            />
            <Row label="Attack Vector" value={cvssData.attackVector} />
            <Row label="Attack Complexity" value={cvssData.attackComplexity} />
            <Row label="Privileges Req." value={cvssData.privilegesRequired} />
            <Row label="User Interaction" value={cvssData.userInteraction} />
            <Row label="Scope" value={cvssData.scope} />
            <Row label="Confidentiality" value={cvssData.confidentialityImpact} />
            <Row label="Integrity" value={cvssData.integrityImpact} />
            <Row label="Availability" value={cvssData.availabilityImpact} />
            {(v31 ?? v30) && (
              <>
                <Row
                  label="Exploitability"
                  value={String(
                    (v31 ?? v30)?.exploitabilityScore ?? "",
                  )}
                />
                <Row
                  label="Impact Score"
                  value={String((v31 ?? v30)?.impactScore ?? "")}
                />
              </>
            )}
          </div>

          {/* v2 fallback if present */}
          {v2 && (
            <div className="mt-4 border-t border-violet-500/10 pt-4">
              <div className="mb-2 text-[10px] uppercase tracking-wider text-gray-600">
                CVSS v2 (Legacy)
              </div>
              <Row
                label="Base Score"
                value={`${v2.cvssData.baseScore} (${v2.baseSeverity ?? ""})`}
              />
              <Row
                label="Vector"
                value={
                  <span className="font-mono text-xs text-gray-500">
                    {v2.cvssData.vectorString}
                  </span>
                }
              />
            </div>
          )}
        </Section>
      )}

      {/* ── Configuration (CPE) ──────────────────────────────────── */}
      {cve.configurations && cve.configurations.length > 0 && (
        <Section
          icon={<Cpu className="h-4 w-4 text-violet-400" />}
          title="Configuration (CPE)"
        >
          <div className="space-y-2">
            {cve.configurations.map((config, ci) =>
              config.nodes.map((node, ni) =>
                node.cpeMatch?.map((cpe, cpi) => (
                  <div
                    key={`${ci}-${ni}-${cpi}`}
                    className="rounded border border-violet-500/5 bg-gray-900/30 px-3 py-2"
                  >
                    <span className="font-mono text-xs text-gray-400">
                      {cpe.criteria}
                    </span>
                    <div className="mt-1 flex gap-3 text-[10px] text-gray-600">
                      {cpe.versionEndIncluding && (
                        <span>≤ {cpe.versionEndIncluding}</span>
                      )}
                      {cpe.versionEndExcluding && (
                        <span>&lt; {cpe.versionEndExcluding}</span>
                      )}
                      {cpe.versionStartIncluding && (
                        <span>≥ {cpe.versionStartIncluding}</span>
                      )}
                      <span
                        className={
                          cpe.vulnerable ? "text-red-400" : "text-green-400"
                        }
                      >
                        {cpe.vulnerable ? "Vulnerable" : "Not Vulnerable"}
                      </span>
                    </div>
                  </div>
                )),
              ),
            )}
          </div>
        </Section>
      )}

      {/* ── Timeline ─────────────────────────────────────────────── */}
      <Section
        icon={<Calendar className="h-4 w-4 text-violet-400" />}
        title="Timeline"
      >
        <div className="flex flex-col gap-0">
          <Row label="Published" value={formatDate(cve.published)} />
          <Row label="Last Modified" value={formatDate(cve.lastModified)} />
          {cve.cisaExploitAdd && (
            <Row label="CISA KEV Added" value={formatDate(cve.cisaExploitAdd)} />
          )}
          {cve.cisaActionDue && (
            <Row label="CISA Action Due" value={formatDate(cve.cisaActionDue)} />
          )}
          {cve.cisaRequiredAction && (
            <Row label="CISA Action" value={cve.cisaRequiredAction} />
          )}
          {cve.cisaVulnerabilityName && (
            <Row label="CISA Name" value={cve.cisaVulnerabilityName} />
          )}
        </div>
      </Section>

      {/* ── Evaluator Notes ──────────────────────────────────────── */}
      {(cve.evaluatorComment || cve.evaluatorSolution || cve.evaluatorImpact) && (
        <Section
          icon={<Info className="h-4 w-4 text-violet-400" />}
          title="Evaluator Notes"
        >
          <div className="flex flex-col gap-0">
            <Row label="Comment" value={cve.evaluatorComment} />
            <Row label="Solution" value={cve.evaluatorSolution} />
            <Row label="Impact" value={cve.evaluatorImpact} />
          </div>
        </Section>
      )}

      {/* ── Weaknesses ───────────────────────────────────────────── */}
      {cve.weaknesses && cve.weaknesses.length > 0 && (
        <Section
          icon={<Bug className="h-4 w-4 text-violet-400" />}
          title="Weaknesses"
        >
          <div className="space-y-2">
            {cve.weaknesses.map((w, i) => (
              <div
                key={i}
                className="flex items-center gap-3 rounded border border-violet-500/5 bg-gray-900/30 px-3 py-2"
              >
                <span className="rounded bg-violet-500/10 px-1.5 py-0.5 font-mono text-xs text-violet-300">
                  {w.description?.[0]?.value ?? "Unknown"}
                </span>
                <span className="text-xs text-gray-500">
                  {w.source} ({w.type})
                </span>
              </div>
            ))}
          </div>
        </Section>
      )}

      {/* ── References (compact) ─────────────────────────────────── */}
      {cve.references && cve.references.length > 0 && (
        <Section
          icon={<Link2 className="h-4 w-4 text-violet-400" />}
          title="References"
        >
          <div className="space-y-1.5">
            {cve.references.map((ref, i) => (
              <div key={i} className="flex items-center gap-2 text-sm">
                <a
                  href={ref.url}
                  target="_blank"
                  rel="noreferrer"
                  className="truncate text-violet-400 transition-colors hover:text-violet-300"
                >
                  {ref.url.replace(/^https?:\/\//, "").split("?")[0]}
                </a>
                {ref.tags && ref.tags.length > 0 && (
                  <div className="flex shrink-0 gap-1">
                    {ref.tags.map((tag) => (
                      <span
                        key={tag}
                        className="rounded bg-gray-800 px-1 py-0.5 text-[10px] text-gray-600"
                      >
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        </Section>
      )}

      {/* ── Vendor Comments ──────────────────────────────────────── */}
      {cve.vendorComments && cve.vendorComments.length > 0 && (
        <Section
          icon={<MessageSquare className="h-4 w-4 text-violet-400" />}
          title="Vendor Comments"
        >
          <div className="space-y-3">
            {cve.vendorComments.map((vc, i) => (
              <div
                key={i}
                className="border-b border-violet-500/5 pb-3 last:border-0"
              >
                <div className="text-sm font-medium text-gray-200">
                  {vc.organization}
                </div>
                <p className="mt-1 text-sm text-gray-400">{vc.comment}</p>
                <p className="mt-1 text-[10px] text-gray-600">
                  Last updated: {formatDate(vc.lastModified)}
                </p>
              </div>
            ))}
          </div>
        </Section>
      )}
    </div>
  );
};

export default VulnNVDDetails;
