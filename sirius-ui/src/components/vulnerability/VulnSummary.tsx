/**
 * VulnSummary — Extracted and modernized "Summary" tab content.
 *
 * Three v4-styled scanner-section cards:
 *   1. Description (prose markdown)
 *   2. Threat Analysis (restyled ThreatBar)
 *   3. References (Lucide icons)
 */

import React from "react";
import { ExternalLink, AlertTriangle, FileText, Link2 } from "lucide-react";
import ReactMarkdown from "react-markdown";
import type { CveItem } from "~/server/api/routers/vulnerability";

interface VulnSummaryProps {
  cve: CveItem;
}

/* ------------------------------------------------------------------ */
/*  Threat summary builder (ported from ThreatBar)                     */
/* ------------------------------------------------------------------ */

function buildThreatSummary(cve: CveItem): string[] {
  const summary: string[] = [];

  if (cve.cisaExploitAdd) {
    summary.push(
      "An entry exists in the CISA Known Exploited Vulnerabilities catalog for this condition.",
    );
  }

  const data = cve.metrics?.cvssMetricV31?.[0]?.cvssData;
  if (!data) return summary;

  const parts = data.vectorString?.split("/") ?? [];
  const av = parts[0]?.split(":")[1];
  const ac = parts[1]?.split(":")[1];
  const pr = parts[2]?.split(":")[1];
  const ui = parts[3]?.split(":")[1];

  if (av === "N")
    summary.push("This vulnerability is remotely exploitable.");
  else if (av === "A")
    summary.push(
      "This vulnerability is remotely exploitable from an adjacent network.",
    );
  else if (av === "L")
    summary.push("This vulnerability is locally exploitable.");
  else if (av === "P")
    summary.push(
      "This vulnerability is only exploitable by a physical attacker.",
    );

  if (ac === "L")
    summary.push("This vulnerability is trivial for an attacker to exploit.");
  else if (ac === "H")
    summary.push("Exploitation of this vulnerability may prove challenging.");

  if (pr === "N")
    summary.push(
      "This vulnerability does not require any special privileges to exploit.",
    );
  else if (pr === "L") summary.push("Only low level access is required.");
  else if (pr === "H")
    summary.push(
      "An elevated level of access is required to exploit this issue.",
    );

  if (ui === "N") summary.push("No user interaction is necessary.");
  else if (ui === "R")
    summary.push(
      "A user must interact with the system to trigger the exploit payload.",
    );

  return summary;
}

/* ------------------------------------------------------------------ */
/*  Component                                                          */
/* ------------------------------------------------------------------ */

export const VulnSummary: React.FC<VulnSummaryProps> = ({ cve }) => {
  const description =
    cve.descriptions?.find((d) => d.lang === "en")?.value ??
    cve.descriptions?.[0]?.value ??
    "No description available.";

  const threatLines = buildThreatSummary(cve);

  return (
    <div className="space-y-6">
      {/* ── Description ──────────────────────────────────────────── */}
      <div className="scanner-section scanner-section-padding">
        <div className="mb-3 flex items-center gap-2 text-xs font-medium uppercase tracking-wider text-gray-500">
          <FileText className="h-4 w-4 text-violet-400" />
          Description
        </div>
        <div className="prose prose-sm prose-invert max-w-none">
          <ReactMarkdown>{description}</ReactMarkdown>
        </div>
      </div>

      {/* ── Threat Analysis ──────────────────────────────────────── */}
      {threatLines.length > 0 && (
        <div className="scanner-section scanner-section-padding">
          <div className="mb-3 flex items-center gap-2 text-xs font-medium uppercase tracking-wider text-gray-500">
            <AlertTriangle className="h-4 w-4 text-violet-400" />
            Threat Analysis
          </div>

          {/* Attack metrics grid */}
          <div className="mb-4 grid grid-cols-2 gap-4 md:grid-cols-4">
            {[
              {
                label: "Attack Vector",
                value:
                  cve.metrics?.cvssMetricV31?.[0]?.cvssData?.attackVector ??
                  "N/A",
              },
              {
                label: "Attack Complexity",
                value:
                  cve.metrics?.cvssMetricV31?.[0]?.cvssData?.attackComplexity ??
                  "N/A",
              },
              {
                label: "Privileges Required",
                value:
                  cve.metrics?.cvssMetricV31?.[0]?.cvssData
                    ?.privilegesRequired ?? "N/A",
              },
              {
                label: "User Interaction",
                value:
                  cve.metrics?.cvssMetricV31?.[0]?.cvssData?.userInteraction ??
                  "N/A",
              },
            ].map((item) => (
              <div key={item.label} className="flex flex-col">
                <span className="text-[10px] uppercase tracking-wider text-gray-500">
                  {item.label}
                </span>
                <span className="text-sm font-medium text-gray-200">
                  {item.value}
                </span>
              </div>
            ))}
          </div>

          {/* Narrative summary */}
          <div className="flex items-start gap-3 rounded-md border border-amber-500/10 bg-amber-500/5 px-4 py-3">
            <AlertTriangle className="mt-0.5 h-4 w-4 shrink-0 text-amber-400" />
            <p className="text-sm leading-relaxed text-gray-300">
              {threatLines.join(" ")}
            </p>
          </div>
        </div>
      )}

      {/* ── References ───────────────────────────────────────────── */}
      <div className="scanner-section scanner-section-padding">
        <div className="mb-3 flex items-center gap-2 text-xs font-medium uppercase tracking-wider text-gray-500">
          <Link2 className="h-4 w-4 text-violet-400" />
          References
        </div>

        {cve.references?.length ? (
          <ul className="space-y-2">
            {cve.references.map((ref) => (
              <li
                key={ref.url}
                className="border-b border-violet-500/5 pb-2 last:border-0"
              >
                <a
                  href={ref.url}
                  target="_blank"
                  rel="noreferrer"
                  className="inline-flex items-center gap-1.5 text-sm text-violet-400 transition-colors hover:text-violet-300"
                >
                  <ExternalLink className="h-3 w-3 shrink-0" />
                  {ref.url.replace(/^https?:\/\//, "").split("?")[0]}
                </a>
                {ref.tags && ref.tags.length > 0 && (
                  <div className="mt-1 flex flex-wrap gap-1">
                    {ref.tags.map((tag) => (
                      <span
                        key={tag}
                        className="rounded bg-gray-800 px-1.5 py-0.5 text-[10px] text-gray-500"
                      >
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
              </li>
            ))}
          </ul>
        ) : (
          <p className="text-sm text-gray-500">No references available.</p>
        )}
      </div>
    </div>
  );
};

export default VulnSummary;
