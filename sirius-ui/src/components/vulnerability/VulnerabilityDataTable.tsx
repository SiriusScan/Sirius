/**
 * VulnerabilityDataTable -- v0.4 self-contained vulnerability table.
 *
 * Follows the EnvironmentDataTable pattern: search, filter presets,
 * export, pagination, and row selection all live inside this component.
 * The orchestrator (VulnerabilityNavigator) passes data + columns only.
 *
 * Search supports structured queries:
 *   severity:critical   cvss:>7   cve:2022   plain text
 *   severity:high,medium cvss:>=9   severity:low OR cvss:<4
 */

"use client";

import React, { useState, useMemo, useRef, useEffect, useCallback } from "react";
import {
  flexRender,
  getCoreRowModel,
  getFilteredRowModel,
  getPaginationRowModel,
  getSortedRowModel,
  useReactTable,
  type ColumnDef,
  type FilterFn,
  type Row,
  type SortingState,
} from "@tanstack/react-table";
import { cn } from "~/components/lib/utils";
import {
  Search,
  X,
  Download,
  RefreshCw,
  ChevronUp,
  ChevronDown,
  Shield,
  Gauge,
  HelpCircle,
} from "lucide-react";
import { type VulnTableData } from "./VulnColumns";
import {
  parseQuery,
  applyQuery,
  QUERY_SYNTAX_HELP,
  type QueryRow,
} from "~/utils/queryParser";

/* ------------------------------------------------------------------ */
/*  Global filter -- uses structured query parser                      */
/* ------------------------------------------------------------------ */

const vulnGlobalFilter: FilterFn<VulnTableData> = (
  row: Row<VulnTableData>,
  _columnId: string,
  filterValue: string,
): boolean => {
  const q = (filterValue ?? "").trim();
  if (!q) return true;

  const parsed = parseQuery(q);
  return applyQuery(parsed, row.original as QueryRow);
};

/* ------------------------------------------------------------------ */
/*  Props                                                              */
/* ------------------------------------------------------------------ */

interface VulnerabilityDataTableProps {
  columns: ColumnDef<VulnTableData, any>[];
  data: VulnTableData[];
  onRefresh?: () => void;
  onRowClick?: (row: VulnTableData) => void;
  isLoading?: boolean;
  /** Controlled search value from orchestrator (for cross-view filtering). */
  searchQuery?: string;
  /** Notify orchestrator of search changes. */
  onSearchChange?: (query: string) => void;
  /** Controlled filter presets from orchestrator. */
  activeFilterPresets?: string[];
  /** Notify orchestrator of filter preset changes. */
  onFilterPresetsChange?: (filters: string[]) => void;
}

/* ------------------------------------------------------------------ */
/*  Component                                                          */
/* ------------------------------------------------------------------ */

export function VulnerabilityDataTable({
  columns,
  data,
  onRefresh,
  onRowClick,
  isLoading = false,
  searchQuery: controlledSearch,
  onSearchChange,
  activeFilterPresets: controlledFilters,
  onFilterPresetsChange,
}: VulnerabilityDataTableProps) {
  /* ---- State (supports both controlled + uncontrolled) ---- */
  const [localSearch, setLocalSearch] = useState("");
  const [localFilters, setLocalFilters] = useState<string[]>([]);

  const globalFilter = controlledSearch ?? localSearch;
  const setGlobalFilter = onSearchChange ?? setLocalSearch;
  const activeFilters = controlledFilters ?? localFilters;
  const setActiveFilters = onFilterPresetsChange ?? setLocalFilters;

  const [rowSelection, setRowSelection] = useState({});
  const [sorting, setSorting] = useState<SortingState>([
    { id: "riskScore", desc: true },
  ]);
  const [showExportDropdown, setShowExportDropdown] = useState(false);
  const [showSyntaxHelp, setShowSyntaxHelp] = useState(false);
  const [searchFocused, setSearchFocused] = useState(false);

  const exportRef = useRef<HTMLDivElement>(null);
  const helpRef = useRef<HTMLDivElement>(null);
  const searchRef = useRef<HTMLInputElement>(null);

  // Close dropdowns on outside click
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (
        exportRef.current &&
        !exportRef.current.contains(event.target as Node)
      ) {
        setShowExportDropdown(false);
      }
      if (
        helpRef.current &&
        !helpRef.current.contains(event.target as Node)
      ) {
        setShowSyntaxHelp(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Keyboard: Escape clears search
  const handleSearchKeyDown = useCallback(
    (e: React.KeyboardEvent<HTMLInputElement>) => {
      if (e.key === "Escape") {
        setGlobalFilter("");
        searchRef.current?.blur();
      }
    },
    [setGlobalFilter],
  );

  /* ---- Pre-filter data based on filter presets ---- */
  const filteredData = useMemo(() => {
    let rows = data;

    // Severity filter presets
    const severityFilters = activeFilters.filter((f) =>
      ["critical", "high", "medium", "low", "info"].includes(f),
    );
    if (severityFilters.length > 0) {
      rows = rows.filter((v) => {
        const sev = v.severity.toLowerCase();
        const normalized = sev === "informational" ? "info" : sev;
        return severityFilters.includes(normalized);
      });
    }

    // CVSS threshold filters (mutually exclusive -- last one wins)
    const cvssFilter = activeFilters.find((f) => f.startsWith("cvss"));
    if (cvssFilter === "cvss9") {
      rows = rows.filter((v) => v.riskScore >= 9.0);
    } else if (cvssFilter === "cvss7") {
      rows = rows.filter((v) => v.riskScore >= 7.0);
    } else if (cvssFilter === "cvss4") {
      rows = rows.filter((v) => v.riskScore >= 4.0);
    }

    return rows;
  }, [data, activeFilters]);

  /* ---- Selection column ---- */
  const selectionColumn: ColumnDef<VulnTableData, any> = {
    id: "select",
    header: ({ table }) => (
      <div className="px-1">
        <input
          type="checkbox"
          className="h-4 w-4 rounded border-gray-600 bg-gray-800 text-violet-500 focus:ring-violet-500/30"
          checked={table.getIsAllPageRowsSelected()}
          ref={(input) => {
            if (input) {
              input.indeterminate =
                table.getIsSomePageRowsSelected() &&
                !table.getIsAllPageRowsSelected();
            }
          }}
          onChange={table.getToggleAllPageRowsSelectedHandler()}
        />
      </div>
    ),
    cell: ({ row }) => (
      <div className="px-1" onClick={(e) => e.stopPropagation()}>
        <input
          type="checkbox"
          className="h-4 w-4 rounded border-gray-600 bg-gray-800 text-violet-500 focus:ring-violet-500/30"
          checked={row.getIsSelected()}
          onChange={row.getToggleSelectedHandler()}
        />
      </div>
    ),
    enableSorting: false,
    enableGlobalFilter: false,
  };

  const columnsWithSelection = useMemo(
    () => [selectionColumn, ...columns],
    [columns],
  );

  /* ---- Table instance ---- */
  const table = useReactTable({
    data: filteredData,
    columns: columnsWithSelection,
    getCoreRowModel: getCoreRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
    globalFilterFn: vulnGlobalFilter,
    state: {
      globalFilter,
      rowSelection,
      sorting,
    },
    onGlobalFilterChange: setGlobalFilter,
    onRowSelectionChange: setRowSelection,
    onSortingChange: setSorting,
    initialState: {
      pagination: { pageSize: 10 },
    },
    enableRowSelection: true,
  });

  /* ---- Filter presets ---- */
  const severityPresets = [
    { name: "Critical", filter: "critical" },
    { name: "High", filter: "high" },
    { name: "Medium", filter: "medium" },
    { name: "Low", filter: "low" },
    { name: "Info", filter: "info" },
  ];

  const cvssPresets = [
    { name: "CVSS \u2265 9.0", filter: "cvss9" },
    { name: "CVSS \u2265 7.0", filter: "cvss7" },
    { name: "CVSS \u2265 4.0", filter: "cvss4" },
  ];

  const toggleFilter = (filter: string) => {
    const updater = (prev: string[]) => {
      // CVSS filters are mutually exclusive (radio behavior)
      if (filter.startsWith("cvss")) {
        const without = prev.filter((f) => !f.startsWith("cvss"));
        return prev.includes(filter) ? without : [...without, filter];
      }
      return prev.includes(filter)
        ? prev.filter((f) => f !== filter)
        : [...prev, filter];
    };
    if (onFilterPresetsChange) {
      onFilterPresetsChange(updater(activeFilters));
    } else {
      setLocalFilters(updater);
    }
  };

  /* ---- Export ---- */
  const handleExport = (format: "csv" | "json") => {
    const selectedRows = table.getSelectedRowModel().rows;
    const exportData =
      selectedRows.length > 0
        ? selectedRows.map((r) => r.original)
        : filteredData;

    if (format === "csv") {
      const headers = ["CVE ID", "Severity", "CVSS", "Description"];
      const rows = exportData.map((v) => [
        v.cve,
        v.severity,
        v.riskScore.toString(),
        `"${v.description.replace(/"/g, '""')}"`,
      ]);
      const csv = [headers, ...rows].map((r) => r.join(",")).join("\n");
      downloadBlob(csv, "text/csv", "vulnerabilities.csv");
    } else {
      const json = exportData.map((v) => ({
        cve: v.cve,
        severity: v.severity,
        riskScore: v.riskScore,
        description: v.description,
      }));
      downloadBlob(
        JSON.stringify(json, null, 2),
        "application/json",
        "vulnerabilities.json",
      );
    }
    setShowExportDropdown(false);
  };

  /* ---- Selected summary ---- */
  const selectedSummary = useMemo(() => {
    const rows = table.getSelectedRowModel().rows;
    if (rows.length === 0) return null;
    return {
      count: rows.length,
      critical: rows.filter(
        (r) => r.original.severity === "CRITICAL",
      ).length,
    };
  }, [table.getSelectedRowModel().rows]);

  /* ---- Render ---- */
  return (
    <div className="w-full">
      {/* ---- Toolbar: Search + Count + Actions ---- */}
      <div className="relative z-20 mb-4 flex items-center justify-between">
        <div className="flex items-center gap-4">
          {/* Search */}
          <div className="relative">
            <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-500" />
            <input
              ref={searchRef}
              type="text"
              placeholder="Search... (severity:critical cvss:>7)"
              value={globalFilter}
              onChange={(e) => setGlobalFilter(e.target.value)}
              onKeyDown={handleSearchKeyDown}
              onFocus={() => setSearchFocused(true)}
              onBlur={() => setTimeout(() => setSearchFocused(false), 150)}
              className="h-9 w-80 rounded-lg border border-violet-500/20 bg-gray-900/50 pl-9 pr-16 text-sm text-white placeholder-gray-500 outline-none focus:border-violet-500/40 focus:ring-1 focus:ring-violet-500/20"
            />
            <div className="absolute right-2.5 top-1/2 flex -translate-y-1/2 items-center gap-1">
              {globalFilter && (
                <button
                  className="text-gray-500 hover:text-gray-300"
                  onClick={() => setGlobalFilter("")}
                >
                  <X className="h-3.5 w-3.5" />
                </button>
              )}
              {/* Syntax help toggle */}
              <div className="relative" ref={helpRef}>
                <button
                  className="text-gray-600 hover:text-gray-400"
                  onClick={() => setShowSyntaxHelp(!showSyntaxHelp)}
                  title="Search syntax help"
                >
                  <HelpCircle className="h-3.5 w-3.5" />
                </button>
                {showSyntaxHelp && (
                  <div className="absolute right-0 top-full z-50 mt-2 w-72 rounded-lg border border-violet-500/20 bg-gray-950 p-2.5 shadow-2xl shadow-black/50">
                    <div className="mb-1.5 text-[10px] font-semibold uppercase tracking-wider text-gray-500">
                      Search Syntax
                    </div>
                    <table className="w-full">
                      <tbody className="text-[11px]">
                        {QUERY_SYNTAX_HELP.map((item) => (
                          <tr key={item.example}>
                            <td className="whitespace-nowrap py-0.5 pr-2.5 align-top font-mono text-violet-400">
                              {item.example}
                            </td>
                            <td className="py-0.5 text-gray-500">
                              {item.desc}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </div>
            {/* Hint shown when search is focused and empty */}
            {searchFocused && !globalFilter && (
              <div className="absolute left-0 top-full z-20 mt-1 rounded-lg border border-violet-500/10 bg-gray-900/95 px-3 py-1.5 text-[11px] text-gray-500 shadow-lg backdrop-blur-sm">
                Try: <span className="text-violet-400">severity:critical</span>{" "}
                or <span className="text-violet-400">cvss:&gt;7</span> or{" "}
                <span className="text-violet-400">severity:high OR nginx</span>
              </div>
            )}
          </div>

          {/* Count */}
          <span className="text-sm text-gray-500">
            {table.getFilteredRowModel().rows.length} vulnerabilities
          </span>
        </div>

        {/* Action buttons */}
        <div className="flex items-center gap-2">
          {onRefresh && (
            <button
              onClick={onRefresh}
              className="flex items-center gap-1.5 rounded-lg border border-violet-500/20 bg-gray-900/50 px-3 py-1.5 text-sm text-gray-400 transition-colors hover:border-violet-500/30 hover:text-white"
            >
              <RefreshCw className={cn("h-3.5 w-3.5", isLoading && "animate-spin")} />
              Refresh
            </button>
          )}

          {/* Export dropdown */}
          <div className="relative" ref={exportRef}>
            <button
              onClick={() => setShowExportDropdown(!showExportDropdown)}
              className="flex items-center gap-1.5 rounded-lg border border-violet-500/20 bg-gray-900/50 px-3 py-1.5 text-sm text-gray-400 transition-colors hover:border-violet-500/30 hover:text-white"
            >
              <Download className="h-3.5 w-3.5" />
              Export
            </button>
            {showExportDropdown && (
              <div className="absolute right-0 top-full z-20 mt-1 w-36 overflow-hidden rounded-lg border border-violet-500/20 bg-gray-900 shadow-xl">
                <button
                  className="w-full px-4 py-2 text-left text-sm text-gray-300 hover:bg-violet-500/10 hover:text-white"
                  onClick={() => handleExport("csv")}
                >
                  Export as CSV
                </button>
                <button
                  className="w-full px-4 py-2 text-left text-sm text-gray-300 hover:bg-violet-500/10 hover:text-white"
                  onClick={() => handleExport("json")}
                >
                  Export as JSON
                </button>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* ---- Filter presets ---- */}
      <div className="mb-4 flex flex-wrap items-center gap-2">
        {severityPresets.map((preset) => (
          <button
            key={preset.filter}
            onClick={() => toggleFilter(preset.filter)}
            className={cn(
              "rounded-full px-3 py-1 text-xs font-medium transition-colors",
              activeFilters.includes(preset.filter)
                ? "bg-violet-500/20 text-violet-300 ring-1 ring-violet-500/30"
                : "bg-gray-800/60 text-gray-400 hover:bg-gray-800 hover:text-gray-300",
            )}
          >
            {preset.name}
          </button>
        ))}

        <div className="mx-1 h-4 w-px bg-violet-500/10" />

        {cvssPresets.map((preset) => (
          <button
            key={preset.filter}
            onClick={() => toggleFilter(preset.filter)}
            className={cn(
              "flex items-center gap-1 rounded-full px-3 py-1 text-xs font-medium transition-colors",
              activeFilters.includes(preset.filter)
                ? "bg-violet-500/20 text-violet-300 ring-1 ring-violet-500/30"
                : "bg-gray-800/60 text-gray-400 hover:bg-gray-800 hover:text-gray-300",
            )}
          >
            <Gauge className="h-3 w-3" />
            {preset.name}
          </button>
        ))}

        {activeFilters.length > 0 && (
          <button
            onClick={() => {
              if (onFilterPresetsChange) {
                onFilterPresetsChange([]);
              } else {
                setLocalFilters([]);
              }
            }}
            className="ml-1 text-xs text-gray-500 hover:text-gray-300"
          >
            Clear all ({activeFilters.length})
          </button>
        )}
      </div>

      {/* ---- Selected summary ---- */}
      {selectedSummary && (
        <div className="mb-4 flex items-center justify-between rounded-lg border border-violet-500/20 bg-violet-500/5 px-4 py-2.5">
          <span className="text-sm text-gray-300">
            <span className="font-medium text-white">
              {selectedSummary.count}
            </span>{" "}
            selected
            {selectedSummary.critical > 0 && (
              <span className="ml-2 text-red-400">
                ({selectedSummary.critical} critical)
              </span>
            )}
          </span>
          <button
            onClick={() => setRowSelection({})}
            className="text-xs text-gray-500 hover:text-gray-300"
          >
            Clear selection
          </button>
        </div>
      )}

      {/* ---- Table ---- */}
      <div className="overflow-auto rounded-lg border border-violet-500/10" style={{ maxHeight: "calc(100vh - 24rem)" }}>
        <table className="w-full divide-y divide-violet-500/10">
          <thead className="sticky top-0 z-10">
            {table.getHeaderGroups().map((headerGroup) => (
              <tr key={headerGroup.id}>
                {headerGroup.headers.map((header) => (
                  <th
                    key={header.id}
                    onClick={header.column.getToggleSortingHandler()}
                    className={cn(
                      "bg-gray-900 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-400",
                      header.column.getCanSort() &&
                        header.id !== "select" &&
                        "cursor-pointer select-none hover:text-gray-200",
                    )}
                  >
                    <div className="flex items-center gap-1.5">
                      {header.isPlaceholder
                        ? null
                        : flexRender(
                            header.column.columnDef.header,
                            header.getContext(),
                          )}
                      {header.column.getCanSort() && (
                        <span className="ml-0.5">
                          {header.column.getIsSorted() === "asc" ? (
                            <ChevronUp className="h-3 w-3" />
                          ) : header.column.getIsSorted() === "desc" ? (
                            <ChevronDown className="h-3 w-3" />
                          ) : (
                            <span className="inline-block h-3 w-3" />
                          )}
                        </span>
                      )}
                    </div>
                  </th>
                ))}
              </tr>
            ))}
          </thead>
          <tbody className="divide-y divide-violet-500/5">
            {isLoading ? (
              <tr>
                <td
                  colSpan={columnsWithSelection.length}
                  className="py-16 text-center"
                >
                  <div className="flex flex-col items-center gap-2">
                    <div className="h-8 w-8 animate-spin rounded-full border-2 border-gray-700 border-t-violet-500" />
                    <span className="text-sm text-gray-400">
                      Loading vulnerabilities...
                    </span>
                  </div>
                </td>
              </tr>
            ) : table.getRowModel().rows.length === 0 ? (
              <tr>
                <td
                  colSpan={columnsWithSelection.length}
                  className="py-16 text-center"
                >
                  <div className="flex flex-col items-center gap-2">
                    <Shield className="h-10 w-10 text-gray-300" />
                    <span className="text-sm text-gray-500">
                      No vulnerabilities found
                    </span>
                  </div>
                </td>
              </tr>
            ) : (
              table.getRowModel().rows.map((row) => (
                <tr
                  key={row.id}
                  onClick={() => onRowClick?.(row.original)}
                  className={cn(
                    "transition-colors",
                    row.getIsSelected()
                      ? "bg-violet-500/10"
                      : "hover:bg-gray-800/30",
                    onRowClick && "cursor-pointer",
                  )}
                >
                  {row.getVisibleCells().map((cell) => (
                    <td
                      key={cell.id}
                      className="px-4 py-3 text-sm text-gray-200"
                      onClick={
                        cell.column.id === "select"
                          ? (e) => e.stopPropagation()
                          : undefined
                      }
                    >
                      {flexRender(
                        cell.column.columnDef.cell,
                        cell.getContext(),
                      )}
                    </td>
                  ))}
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      {/* ---- Pagination ---- */}
      <div className="mt-4 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <select
            value={table.getState().pagination.pageSize}
            onChange={(e) => table.setPageSize(Number(e.target.value))}
            className="rounded-lg border border-violet-500/20 bg-gray-900/50 px-2 py-1 text-sm text-gray-300 outline-none"
          >
            {[10, 20, 30, 50].map((size) => (
              <option key={size} value={size}>
                Show {size}
              </option>
            ))}
          </select>
          <span className="text-sm text-gray-500">
            Showing{" "}
            {table.getState().pagination.pageIndex *
              table.getState().pagination.pageSize +
              1}{" "}
            to{" "}
            {Math.min(
              (table.getState().pagination.pageIndex + 1) *
                table.getState().pagination.pageSize,
              table.getFilteredRowModel().rows.length,
            )}{" "}
            of {table.getFilteredRowModel().rows.length}
          </span>
        </div>

        <div className="flex items-center gap-1.5">
          <button
            className={cn(
              "rounded-lg border border-violet-500/20 px-3 py-1 text-sm text-gray-400 transition-colors hover:text-white",
              !table.getCanPreviousPage() && "cursor-not-allowed opacity-40",
            )}
            onClick={() => table.previousPage()}
            disabled={!table.getCanPreviousPage()}
          >
            Previous
          </button>
          {Array.from(
            { length: Math.min(5, table.getPageCount()) },
            (_, i) => (
              <button
                key={i}
                className={cn(
                  "rounded-lg border px-3 py-1 text-sm transition-colors",
                  table.getState().pagination.pageIndex === i
                    ? "border-violet-500/40 bg-violet-500/15 text-violet-300"
                    : "border-violet-500/20 text-gray-400 hover:text-white",
                )}
                onClick={() => table.setPageIndex(i)}
              >
                {i + 1}
              </button>
            ),
          )}
          <button
            className={cn(
              "rounded-lg border border-violet-500/20 px-3 py-1 text-sm text-gray-400 transition-colors hover:text-white",
              !table.getCanNextPage() && "cursor-not-allowed opacity-40",
            )}
            onClick={() => table.nextPage()}
            disabled={!table.getCanNextPage()}
          >
            Next
          </button>
        </div>
      </div>
    </div>
  );
}

/* ------------------------------------------------------------------ */
/*  Helper                                                             */
/* ------------------------------------------------------------------ */

function downloadBlob(content: string, type: string, filename: string) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
