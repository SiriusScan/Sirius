/**
 * VulnerabilityNavigator — v0.4 Clean Orchestrator
 *
 * Follows the same header pattern as Dashboard, Scanner, and Operator Console:
 * sticky header bar with icon + title + inline stat badges.
 *
 * Two views: Table (unified, with expandable descriptions) and Grouped.
 *
 * Search and filter state is lifted here so both views share the same
 * query/preset context. Switching between Table and Grouped preserves
 * the active search and filter presets.
 */

import React, { useState, useMemo, useCallback } from "react";
import { useRouter } from "next/router";
import { api } from "~/utils/api";
import {
  Shield,
  LayoutGrid,
  Layers,
  Plus,
} from "lucide-react";
import { cn } from "~/components/lib/utils";

import { VulnerabilityDataTable } from "./VulnerabilityDataTable";
import { VulnGroupedView } from "./VulnGroupedView";
import { VulnerabilitySeverityChart } from "./VulnerabilitySeverityChart";
import { vulnColumns } from "./VulnColumns";
import { AddVulnerabilityPanel } from "./AddVulnerabilityPanel";

import {
  type VulnerabilityItem,
  type SeverityCounts,
  type SeverityLevel,
} from "./types";
import { riskScoreToSeverity } from "~/utils/riskScoreCalculator";

import { parseQuery, applyQuery, type QueryRow } from "~/utils/queryParser";
import { SEVERITY_COLORS } from "~/utils/severityTheme";

/* ------------------------------------------------------------------ */
/*  API response shape (matches tRPC router)                           */
/* ------------------------------------------------------------------ */

interface ApiVulnerability {
  vid: string;
  title: string;
  hostCount: number;
  description: string;
  riskScore: number;
}

/* ------------------------------------------------------------------ */
/*  Severity palette for header chips (from canonical severityTheme)   */
/* ------------------------------------------------------------------ */

const SEVERITY_CHIPS = [
  { key: "critical" as const, label: "Critical", bg: SEVERITY_COLORS.critical.bg, text: SEVERITY_COLORS.critical.text, ring: SEVERITY_COLORS.critical.ring },
  { key: "high" as const, label: "High", bg: SEVERITY_COLORS.high.bg, text: SEVERITY_COLORS.high.text, ring: SEVERITY_COLORS.high.ring },
  { key: "medium" as const, label: "Medium", bg: SEVERITY_COLORS.medium.bg, text: SEVERITY_COLORS.medium.text, ring: SEVERITY_COLORS.medium.ring },
  { key: "low" as const, label: "Low", bg: SEVERITY_COLORS.low.bg, text: SEVERITY_COLORS.low.text, ring: SEVERITY_COLORS.low.ring },
  { key: "informational" as const, label: "Info", bg: SEVERITY_COLORS.info.bg, text: SEVERITY_COLORS.info.text, ring: SEVERITY_COLORS.info.ring },
];

/* ------------------------------------------------------------------ */
/*  View modes (Table unified with Command, plus Grouped)              */
/* ------------------------------------------------------------------ */

type NavigatorView = "table" | "grouped";

const VIEW_TABS: { id: NavigatorView; label: string; icon: React.ElementType }[] = [
  { id: "table", label: "Table", icon: LayoutGrid },
  { id: "grouped", label: "Grouped", icon: Layers },
];

/* ------------------------------------------------------------------ */
/*  VulnerabilityNavigator                                             */
/* ------------------------------------------------------------------ */

export const VulnerabilityNavigator: React.FC = () => {
  const router = useRouter();
  const [viewMode, setViewMode] = useState<NavigatorView>("table");
  const [selectedVulns, setSelectedVulns] = useState<string[]>([]);
  const [addPanelOpen, setAddPanelOpen] = useState(false);

  /* ---- Lifted search & filter state (shared across views) ---- */
  const [searchQuery, setSearchQuery] = useState("");
  const [activeFilterPresets, setActiveFilterPresets] = useState<string[]>([]);

  /* ---- API query (single source of truth) ---- */
  const {
    data: vulnData,
    isLoading,
    refetch,
  } = api.vulnerability.getAllVulnerabilities.useQuery(undefined, {
    refetchOnWindowFocus: true,
    staleTime: 1000 * 60 * 5,
  });

  /* ---- Map API data -> VulnerabilityItem[] ---- */
  const vulnerabilities = useMemo<VulnerabilityItem[]>(() => {
    if (!vulnData?.vulnerabilities?.length) return [];
    return vulnData.vulnerabilities.map((v: ApiVulnerability) => {
      const s = riskScoreToSeverity(v.riskScore);
      return {
        cve: v.vid,
        title: v.title,
        severity: (s === "info" ? "INFORMATIONAL" : s.toUpperCase()) as SeverityLevel,
        description: v.description,
        riskScore: v.riskScore,
        published: new Date().toISOString(),
        lastModified: new Date().toISOString(),
        references: [],
        affectedHosts: Array(v.hostCount).fill("host") as string[],
      };
    });
  }, [vulnData]);

  /* ---- Severity counts ---- */
  const severityCounts = useMemo<SeverityCounts>(
    () => ({
      critical: vulnData?.counts?.critical ?? 0,
      high: vulnData?.counts?.high ?? 0,
      medium: vulnData?.counts?.medium ?? 0,
      low: vulnData?.counts?.low ?? 0,
      informational: vulnData?.counts?.informational ?? 0,
      total: vulnData?.counts?.total,
    }),
    [vulnData],
  );

  /* ---- Pre-filter for grouped view (same logic the table applies) ---- */
  const filteredVulnerabilities = useMemo(() => {
    let rows = vulnerabilities;

    // Apply severity preset filters
    const severityFilters = activeFilterPresets.filter((f) =>
      ["critical", "high", "medium", "low", "info"].includes(f),
    );
    if (severityFilters.length > 0) {
      rows = rows.filter((v) => {
        const sev = v.severity.toLowerCase();
        const normalized = sev === "informational" ? "info" : sev;
        return severityFilters.includes(normalized);
      });
    }

    // Apply CVSS threshold presets
    const cvssFilter = activeFilterPresets.find((f) => f.startsWith("cvss"));
    if (cvssFilter === "cvss9") {
      rows = rows.filter((v) => v.riskScore >= 9.0);
    } else if (cvssFilter === "cvss7") {
      rows = rows.filter((v) => v.riskScore >= 7.0);
    } else if (cvssFilter === "cvss4") {
      rows = rows.filter((v) => v.riskScore >= 4.0);
    }

    // Apply structured search query
    const q = searchQuery.trim();
    if (q) {
      const parsed = parseQuery(q);
      rows = rows.filter((v) => applyQuery(parsed, v as unknown as QueryRow));
    }

    return rows;
  }, [vulnerabilities, activeFilterPresets, searchQuery]);

  /* ---- Handlers ---- */
  const handleRefresh = useCallback(() => void refetch(), [refetch]);

  const navigateToVulnerability = useCallback(
    (cveId: string) => {
      void router.push(`/vulnerability?id=${encodeURIComponent(cveId)}`);
    },
    [router],
  );

  const toggleVulnSelection = useCallback(
    (cve: string) =>
      setSelectedVulns((prev) =>
        prev.includes(cve) ? prev.filter((id) => id !== cve) : [...prev, cve],
      ),
    [],
  );

  /* ---- Render ---- */
  return (
    <div className="relative z-20 -mt-14 space-y-6">
      {/* ── Sticky Header Bar (matching dashboard/scanner/terminal) ── */}
      <div className="sticky top-2 z-30 -mx-4 border-b border-violet-500/20 bg-gray-900/95 px-4 py-3 shadow-lg shadow-black/20 backdrop-blur-sm md:-mx-6 md:px-6">
        <div className="flex items-center gap-3">
          {/* Icon + Title */}
          <div className="flex shrink-0 items-center gap-3">
            <div className="flex h-12 w-12 items-center justify-center rounded-xl bg-violet-500/10 ring-2 ring-violet-500/20">
              <Shield className="h-6 w-6 text-violet-400" />
            </div>
            <h1 className="whitespace-nowrap text-2xl font-bold tracking-tight text-white">
              Vulnerability Navigator
            </h1>
          </div>

          {/* Severity chips */}
          {!isLoading && vulnerabilities.length > 0 && (
            <div className="ml-1 flex items-center gap-2">
              {SEVERITY_CHIPS.map(({ key, label, bg, text, ring }) => {
                const count = severityCounts[key];
                if (count === 0) return null;
                return (
                  <div
                    key={key}
                    className={cn(
                      "flex items-center gap-1.5 rounded-lg px-2.5 py-1 ring-1",
                      bg,
                      ring,
                    )}
                  >
                    <span className={cn("text-sm font-bold tabular-nums", text)}>
                      {count}
                    </span>
                    <span className={cn("text-xs font-medium", text)}>
                      {label}
                    </span>
                  </div>
                );
              })}
            </div>
          )}

          {/* Spacer */}
          <div className="flex-1" />

          {/* Add Vulnerability button */}
          <button
            onClick={() => setAddPanelOpen(true)}
            className="flex shrink-0 items-center gap-1.5 rounded-md border border-violet-500/20 bg-violet-500/10 px-3 py-1.5 text-xs font-medium text-violet-300 transition-colors hover:border-violet-500/30 hover:bg-violet-500/20"
          >
            <Plus className="h-3.5 w-3.5" />
            Add Vulnerability
          </button>

          {/* View tabs (right side of header) */}
          <nav className="flex shrink-0 items-center gap-1 pr-14">
            {VIEW_TABS.map(({ id, label, icon: Icon }) => (
              <button
                key={id}
                onClick={() => setViewMode(id)}
                className={cn(
                  "flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-sm font-medium transition-all",
                  viewMode === id
                    ? "bg-violet-500/20 text-white ring-1 ring-violet-500/30"
                    : "text-gray-400 hover:bg-gray-800/60 hover:text-gray-200",
                )}
              >
                <Icon className="h-3.5 w-3.5" />
                {label}
              </button>
            ))}
          </nav>
        </div>
      </div>

      {/* Severity distribution chart */}
      {!isLoading &&
        severityCounts.total !== undefined &&
        severityCounts.total > 0 && (
          <VulnerabilitySeverityChart counts={severityCounts} />
        )}

      {/* Main content panel */}
      <div className="scanner-section scanner-section-padding">
        {/* Loading state */}
        {isLoading && (
          <div className="flex flex-col items-center justify-center py-20">
            <div className="h-10 w-10 animate-spin rounded-full border-2 border-gray-700 border-t-violet-500" />
            <span className="mt-3 text-sm text-gray-400">
              Loading vulnerabilities...
            </span>
          </div>
        )}

        {/* Empty state */}
        {!isLoading && vulnerabilities.length === 0 && (
          <div className="flex flex-col items-center justify-center py-20">
            <Shield className="h-12 w-12 text-gray-300" />
            <span className="mt-3 text-sm text-gray-500">
              No vulnerabilities found
            </span>
            <p className="mt-1 text-xs text-gray-400">
              Run a scan to discover vulnerabilities in your environment.
            </p>
          </div>
        )}

        {/* Table view (unified -- includes expandable descriptions) */}
        {!isLoading && vulnerabilities.length > 0 && viewMode === "table" && (
          <VulnerabilityDataTable
            columns={vulnColumns}
            data={vulnerabilities}
            onRefresh={handleRefresh}
            onRowClick={(row) => navigateToVulnerability(row.cve)}
            isLoading={isLoading}
            searchQuery={searchQuery}
            onSearchChange={setSearchQuery}
            activeFilterPresets={activeFilterPresets}
            onFilterPresetsChange={setActiveFilterPresets}
          />
        )}

        {/* Grouped view -- receives pre-filtered data from orchestrator */}
        {!isLoading &&
          vulnerabilities.length > 0 &&
          viewMode === "grouped" && (
            <>
              {/* Shared search/filter toolbar for grouped view */}
              <GroupedViewToolbar
                searchQuery={searchQuery}
                onSearchChange={setSearchQuery}
                activeFilters={activeFilterPresets}
                onFilterPresetsChange={setActiveFilterPresets}
                totalCount={filteredVulnerabilities.length}
              />
              <VulnGroupedView
                data={filteredVulnerabilities}
                onViewDetails={(cve) => navigateToVulnerability(cve)}
                selectedVulns={selectedVulns}
                onToggleSelect={toggleVulnSelection}
              />
            </>
          )}
      </div>

      {/* Add Vulnerability slide-over panel */}
      <AddVulnerabilityPanel
        isOpen={addPanelOpen}
        onClose={() => setAddPanelOpen(false)}
        onSuccess={() => void refetch()}
      />
    </div>
  );
};

/* ------------------------------------------------------------------ */
/*  Compact toolbar for grouped view (search + filter presets)          */
/* ------------------------------------------------------------------ */

import {
  Search,
  X,
  HelpCircle,
  Gauge,
} from "lucide-react";
import { QUERY_SYNTAX_HELP } from "~/utils/queryParser";

interface GroupedViewToolbarProps {
  searchQuery: string;
  onSearchChange: (q: string) => void;
  activeFilters: string[];
  onFilterPresetsChange: (filters: string[]) => void;
  totalCount: number;
}

const SEVERITY_PRESETS = [
  { name: "Critical", filter: "critical" },
  { name: "High", filter: "high" },
  { name: "Medium", filter: "medium" },
  { name: "Low", filter: "low" },
  { name: "Info", filter: "info" },
];

const CVSS_PRESETS = [
  { name: "CVSS \u2265 9.0", filter: "cvss9" },
  { name: "CVSS \u2265 7.0", filter: "cvss7" },
  { name: "CVSS \u2265 4.0", filter: "cvss4" },
];

function GroupedViewToolbar({
  searchQuery,
  onSearchChange,
  activeFilters,
  onFilterPresetsChange,
  totalCount,
}: GroupedViewToolbarProps) {
  const [showSyntaxHelp, setShowSyntaxHelp] = React.useState(false);
  const [searchFocused, setSearchFocused] = React.useState(false);
  const helpRef = React.useRef<HTMLDivElement>(null);
  const searchRef = React.useRef<HTMLInputElement>(null);

  React.useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (helpRef.current && !helpRef.current.contains(event.target as Node)) {
        setShowSyntaxHelp(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const toggleFilter = (filter: string) => {
    if (filter.startsWith("cvss")) {
      const without = activeFilters.filter((f) => !f.startsWith("cvss"));
      onFilterPresetsChange(
        activeFilters.includes(filter) ? without : [...without, filter],
      );
    } else {
      onFilterPresetsChange(
        activeFilters.includes(filter)
          ? activeFilters.filter((f) => f !== filter)
          : [...activeFilters, filter],
      );
    }
  };

  return (
    <div className="mb-4 space-y-3">
      {/* Search + Count */}
      <div className="flex items-center gap-4">
        <div className="relative">
          <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-500" />
          <input
            ref={searchRef}
            type="text"
            placeholder="Search... (severity:critical cvss:>7)"
            value={searchQuery}
            onChange={(e) => onSearchChange(e.target.value)}
            onKeyDown={(e) => {
              if (e.key === "Escape") {
                onSearchChange("");
                searchRef.current?.blur();
              }
            }}
            onFocus={() => setSearchFocused(true)}
            onBlur={() => setTimeout(() => setSearchFocused(false), 150)}
            className="h-9 w-80 rounded-lg border border-violet-500/20 bg-gray-900/50 pl-9 pr-16 text-sm text-white placeholder-gray-500 outline-none focus:border-violet-500/40 focus:ring-1 focus:ring-violet-500/20"
          />
          <div className="absolute right-2.5 top-1/2 flex -translate-y-1/2 items-center gap-1">
            {searchQuery && (
              <button
                className="text-gray-500 hover:text-gray-300"
                onClick={() => onSearchChange("")}
              >
                <X className="h-3.5 w-3.5" />
              </button>
            )}
            <div className="relative" ref={helpRef}>
              <button
                className="text-gray-600 hover:text-gray-400"
                onClick={() => setShowSyntaxHelp(!showSyntaxHelp)}
                title="Search syntax help"
              >
                <HelpCircle className="h-3.5 w-3.5" />
              </button>
              {showSyntaxHelp && (
                <div className="absolute right-0 top-full z-50 mt-2 w-72 rounded-lg border border-violet-500/20 bg-gray-950 p-2.5 shadow-2xl shadow-black/50">
                  <div className="mb-1.5 text-[10px] font-semibold uppercase tracking-wider text-gray-500">
                    Search Syntax
                  </div>
                  <table className="w-full">
                    <tbody className="text-[11px]">
                      {QUERY_SYNTAX_HELP.map((item) => (
                        <tr key={item.example}>
                          <td className="whitespace-nowrap py-0.5 pr-2.5 align-top font-mono text-violet-400">
                            {item.example}
                          </td>
                          <td className="py-0.5 text-gray-500">
                            {item.desc}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
          {searchFocused && !searchQuery && (
            <div className="absolute left-0 top-full z-20 mt-1 rounded-lg border border-violet-500/10 bg-gray-900/95 px-3 py-1.5 text-[11px] text-gray-500 shadow-lg backdrop-blur-sm">
              Try: <span className="text-violet-400">severity:critical</span>{" "}
              or <span className="text-violet-400">cvss:&gt;7</span> or{" "}
              <span className="text-violet-400">severity:high OR nginx</span>
            </div>
          )}
        </div>
        <span className="text-sm text-gray-500">
          {totalCount} vulnerabilities
        </span>
      </div>

      {/* Filter presets */}
      <div className="flex flex-wrap items-center gap-2">
        {SEVERITY_PRESETS.map((preset) => (
          <button
            key={preset.filter}
            onClick={() => toggleFilter(preset.filter)}
            className={cn(
              "rounded-full px-3 py-1 text-xs font-medium transition-colors",
              activeFilters.includes(preset.filter)
                ? "bg-violet-500/20 text-violet-300 ring-1 ring-violet-500/30"
                : "bg-gray-800/60 text-gray-400 hover:bg-gray-800 hover:text-gray-300",
            )}
          >
            {preset.name}
          </button>
        ))}

        <div className="mx-1 h-4 w-px bg-violet-500/10" />

        {CVSS_PRESETS.map((preset) => (
          <button
            key={preset.filter}
            onClick={() => toggleFilter(preset.filter)}
            className={cn(
              "flex items-center gap-1 rounded-full px-3 py-1 text-xs font-medium transition-colors",
              activeFilters.includes(preset.filter)
                ? "bg-violet-500/20 text-violet-300 ring-1 ring-violet-500/30"
                : "bg-gray-800/60 text-gray-400 hover:bg-gray-800 hover:text-gray-300",
            )}
          >
            <Gauge className="h-3 w-3" />
            {preset.name}
          </button>
        ))}

        {activeFilters.length > 0 && (
          <button
            onClick={() => onFilterPresetsChange([])}
            className="ml-1 text-xs text-gray-500 hover:text-gray-300"
          >
            Clear all ({activeFilters.length})
          </button>
        )}
      </div>
    </div>
  );
}
