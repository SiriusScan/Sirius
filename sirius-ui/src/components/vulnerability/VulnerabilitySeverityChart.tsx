/**
 * VulnerabilitySeverityChart — v0.4 horizontal bar chart
 *
 * Uses @nivo/bar (ResponsiveBar) to show a severity distribution
 * of vulnerabilities. Accepts SeverityCounts as props (no separate
 * API call -- data comes from the orchestrator).
 *
 * Tooltip is managed entirely outside of Nivo to avoid Nivo's
 * built-in repositioning flicker. It follows the mouse cursor
 * via the container's onMouseMove, while individual bars control
 * which data is displayed.
 */

import React, { useMemo, useRef, useCallback, useState } from "react";
import dynamic from "next/dynamic";
import { cn } from "~/components/lib/utils";
import { SEVERITY_COLORS } from "~/utils/severityTheme";
import { type SeverityCounts } from "./types";
import { type BarDatum, type BarItemProps } from "@nivo/bar";

const ResponsiveBar = dynamic(
  () => import("@nivo/bar").then((m) => m.ResponsiveBar),
  { ssr: false },
);

/* ------------------------------------------------------------------ */
/*  Severity palette — Critical first (top), Info last (bottom)        */
/* ------------------------------------------------------------------ */

const SEVERITY_ORDER = [
  { key: "informational" as const, label: "Info", color: SEVERITY_COLORS.info.hex },
  { key: "low" as const, label: "Low", color: SEVERITY_COLORS.low.hex },
  { key: "medium" as const, label: "Medium", color: SEVERITY_COLORS.medium.hex },
  { key: "high" as const, label: "High", color: SEVERITY_COLORS.high.hex },
  { key: "critical" as const, label: "Critical", color: SEVERITY_COLORS.critical.hex },
];

/** Map label back to hex for the axis tick coloring */
const LABEL_COLOR_MAP: Record<string, string> = {
  Critical: SEVERITY_COLORS.critical.hex,
  High: SEVERITY_COLORS.high.hex,
  Medium: SEVERITY_COLORS.medium.hex,
  Low: SEVERITY_COLORS.low.hex,
  Info: SEVERITY_COLORS.info.hex,
};

/* ------------------------------------------------------------------ */
/*  Chart bar data shape                                               */
/* ------------------------------------------------------------------ */

interface ChartBarData extends BarDatum {
  severity: string;
  count: number;
  color: string;
  pct: string;
  maxCount: number;
}

/* ------------------------------------------------------------------ */
/*  Module-level hover bridge                                          */
/*  Bars set which data is hovered; the container tracks the cursor.   */
/* ------------------------------------------------------------------ */

let setHoveredData: ((data: ChartBarData | null) => void) | null = null;

/* ------------------------------------------------------------------ */
/*  Custom bar component — right-end rounding + ghost track + hover    */
/* ------------------------------------------------------------------ */

const CORNER_R = 5;

function RoundedBar(props: BarItemProps<ChartBarData>) {
  const { bar } = props;
  const { x, y, width, height, color } = bar;
  const data = bar.data.data as ChartBarData;

  const [isHovered, setIsHovered] = useState(false);

  const handleMouseEnter = useCallback(() => {
    setIsHovered(true);
    setHoveredData?.(data);
  }, [data]);

  const handleMouseLeave = useCallback(() => {
    setIsHovered(false);
    setHoveredData?.(null);
  }, []);

  if (height <= 0) return null;

  /* ---- Ghost track (full-width background) ---- */
  const maxWidth =
    data.maxCount > 0 && data.count > 0
      ? (width / data.count) * data.maxCount
      : width;
  const trackR = Math.min(CORNER_R, maxWidth / 2, height / 2);
  const trackD = [
    `M ${x},${y}`,
    `L ${x + maxWidth - trackR},${y}`,
    `Q ${x + maxWidth},${y} ${x + maxWidth},${y + trackR}`,
    `L ${x + maxWidth},${y + height - trackR}`,
    `Q ${x + maxWidth},${y + height} ${x + maxWidth - trackR},${y + height}`,
    `L ${x},${y + height}`,
    `Z`,
  ].join(" ");

  /* ---- Value bar ---- */
  const barWidth = Math.max(width, 0);
  const r = Math.min(CORNER_R, barWidth / 2, height / 2);
  const barD =
    barWidth > 0
      ? [
          `M ${x},${y}`,
          `L ${x + barWidth - r},${y}`,
          `Q ${x + barWidth},${y} ${x + barWidth},${y + r}`,
          `L ${x + barWidth},${y + height - r}`,
          `Q ${x + barWidth},${y + height} ${x + barWidth - r},${y + height}`,
          `L ${x},${y + height}`,
          `Z`,
        ].join(" ")
      : "";

  /* ---- Labels ---- */
  const labelText = `${data.count}`;
  const pctText = `${data.pct}%`;
  const showLabel = barWidth > 30;
  const showPct = barWidth > 70;

  return (
    <g
      onMouseEnter={handleMouseEnter}
      onMouseLeave={handleMouseLeave}
      style={{ cursor: "default" }}
    >
      {/* Ghost track */}
      <path d={trackD} fill="rgba(255,255,255,0.04)" pointerEvents="none" />

      {/* Hit area */}
      <rect x={x} y={y} width={maxWidth} height={height} fill="transparent" />

      {/* Value bar */}
      {barWidth > 0 && (
        <path
          d={barD}
          fill={color}
          style={{
            transition: "filter 150ms ease",
            filter: isHovered ? "brightness(1.2)" : undefined,
          }}
          pointerEvents="none"
        />
      )}

      {/* Labels inside bar */}
      {showLabel && (
        <text
          x={x + 12}
          y={y + height / 2}
          textAnchor="start"
          dominantBaseline="central"
          fill="#ffffff"
          fontSize={12}
          fontWeight={600}
          pointerEvents="none"
        >
          {labelText}
        </text>
      )}
      {showPct && (
        <text
          x={x + barWidth - 10}
          y={y + height / 2}
          textAnchor="end"
          dominantBaseline="central"
          fill="rgba(255,255,255,0.6)"
          fontSize={10}
          fontWeight={400}
          pointerEvents="none"
        >
          {pctText}
        </text>
      )}
    </g>
  );
}

/* ------------------------------------------------------------------ */
/*  Nivo dark theme                                                    */
/* ------------------------------------------------------------------ */

const DARK_THEME = {
  background: "transparent",
  text: { fontSize: 12, fill: "#9ca3af" },
  axis: {
    domain: { line: { stroke: "transparent", strokeWidth: 0 } },
    legend: { text: { fontSize: 12, fill: "#9ca3af" } },
    ticks: {
      line: { stroke: "transparent", strokeWidth: 0 },
      text: { fontSize: 11, fill: "#9ca3af" },
    },
  },
  grid: { line: { stroke: "#1f2937", strokeWidth: 1 } },
};

/* ------------------------------------------------------------------ */
/*  Props                                                              */
/* ------------------------------------------------------------------ */

export interface VulnerabilitySeverityChartProps {
  counts: SeverityCounts;
  className?: string;
  /** Chart height in pixels. Default: 200 */
  height?: number;
}

/* ------------------------------------------------------------------ */
/*  Component                                                          */
/* ------------------------------------------------------------------ */

export const VulnerabilitySeverityChart: React.FC<
  VulnerabilitySeverityChartProps
> = ({ counts, className, height = 200 }) => {
  const total =
    counts.total ??
    counts.critical + counts.high + counts.medium + counts.low + counts.informational;

  const chartData = useMemo(() => {
    return SEVERITY_ORDER.filter(({ key }) => counts[key] > 0).map(
      ({ key, label, color }) => {
        const count = counts[key];
        const pct = total > 0 ? ((count / total) * 100).toFixed(0) : "0";
        return { severity: label, count, color, pct, maxCount: total };
      },
    );
  }, [counts, total]);

  /* ---- Tooltip state ---- */
  const containerRef = useRef<HTMLDivElement>(null);
  const [hoveredData, _setHoveredData] = useState<ChartBarData | null>(null);
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });

  // Register the callback bridge so bars can set hovered data
  setHoveredData = _setHoveredData;

  // Track cursor position relative to the container
  const handleMouseMove = useCallback(
    (e: React.MouseEvent<HTMLDivElement>) => {
      const rect = containerRef.current?.getBoundingClientRect();
      if (!rect) return;
      setMousePos({
        x: e.clientX - rect.left,
        y: e.clientY - rect.top,
      });
    },
    [],
  );

  const handleMouseLeave = useCallback(() => {
    _setHoveredData(null);
  }, []);

  const tooltipVisible = hoveredData != null;

  if (chartData.length === 0) return null;

  return (
    <div className={cn("scanner-section scanner-section-padding", className)}>
      <div className="mb-3 flex items-center justify-between">
        <span className="text-xs font-semibold uppercase tracking-wider text-gray-400">
          Severity Distribution
        </span>
        <span className="text-xs text-gray-500">{total} total</span>
      </div>

      {/* Chart container — tracks mouse for tooltip positioning */}
      <div
        ref={containerRef}
        style={{ height, position: "relative" }}
        onMouseMove={handleMouseMove}
        onMouseLeave={handleMouseLeave}
      >
        <ResponsiveBar
          data={chartData}
          keys={["count"]}
          indexBy="severity"
          layout="horizontal"
          margin={{ top: 0, right: 40, bottom: 0, left: 80 }}
          padding={0.3}
          valueScale={{ type: "linear" }}
          indexScale={{ type: "band", round: true }}
          colors={({ data }) => (data as { color: string }).color}
          borderRadius={0}
          borderColor="transparent"
          barComponent={RoundedBar as any}
          axisTop={null}
          axisRight={null}
          axisBottom={null}
          axisLeft={{
            tickSize: 0,
            tickPadding: 12,
            tickRotation: 0,
            renderTick: ({ value, x, y }) => {
              const labelColor = LABEL_COLOR_MAP[value as string] ?? "#9ca3af";
              return (
                <g transform={`translate(${x},${y})`}>
                  <text
                    textAnchor="end"
                    dominantBaseline="central"
                    dx={-12}
                    style={{ fill: labelColor, fontSize: 11, fontWeight: 500 }}
                  >
                    {value}
                  </text>
                </g>
              );
            },
          }}
          enableGridX={false}
          enableGridY={false}
          enableLabel={false}
          isInteractive={false}
          role="application"
          ariaLabel="Vulnerability severity distribution"
          theme={DARK_THEME}
          animate={true}
          motionConfig="gentle"
        />

        {/* ---- Cursor-following tooltip ---- */}
        <div
          style={{
            position: "absolute",
            left: mousePos.x + 14,
            top: mousePos.y - 8,
            pointerEvents: "none",
            opacity: tooltipVisible ? 1 : 0,
            transition: "opacity 120ms ease",
            zIndex: 50,
          }}
        >
          {hoveredData && (
            <div
              style={{
                background: "#111827",
                border: "1px solid rgba(139, 92, 246, 0.25)",
                borderRadius: 8,
                padding: "8px 12px",
                boxShadow: "0 8px 24px rgba(0,0,0,0.5)",
                fontSize: 12,
                color: "#f9fafb",
                minWidth: 140,
                whiteSpace: "nowrap",
              }}
            >
              <div
                style={{
                  display: "flex",
                  alignItems: "center",
                  gap: 8,
                  marginBottom: 4,
                }}
              >
                <span
                  style={{
                    width: 10,
                    height: 10,
                    borderRadius: 3,
                    background: hoveredData.color,
                    display: "inline-block",
                    flexShrink: 0,
                  }}
                />
                <span style={{ fontWeight: 600 }}>{hoveredData.severity}</span>
              </div>
              <div style={{ color: "#9ca3af", lineHeight: 1.6 }}>
                <span style={{ color: "#ffffff", fontWeight: 500 }}>
                  {hoveredData.count}
                </span>{" "}
                vulnerabilit{hoveredData.count === 1 ? "y" : "ies"}
                <br />
                <span style={{ color: "#ffffff", fontWeight: 500 }}>
                  {hoveredData.pct}%
                </span>{" "}
                of {hoveredData.maxCount} total
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};
