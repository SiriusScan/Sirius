/**
 * Unified Vulnerability Types
 *
 * Single source of truth for vulnerability-related type definitions
 * used across the vulnerability page, scanner, host, and dashboard pages.
 */

import { type SourceAttribution } from "~/types/scanTypes";

/* ------------------------------------------------------------------ */
/*  Core types                                                         */
/* ------------------------------------------------------------------ */

/** Canonical severity levels used across the application. */
export type SeverityLevel =
  | "CRITICAL"
  | "HIGH"
  | "MEDIUM"
  | "LOW"
  | "INFORMATIONAL";

/** Available view modes for the vulnerability navigator. */
export type ViewMode = "table" | "command" | "grouped";

/** Severity count breakdown used in summaries and filter badges. */
export interface SeverityCounts {
  critical: number;
  high: number;
  medium: number;
  low: number;
  informational: number;
  total?: number;
}

/* ------------------------------------------------------------------ */
/*  Vulnerability data shapes                                          */
/* ------------------------------------------------------------------ */

/** Base vulnerability item for table display. */
export interface VulnerabilityItem {
  cve: string;
  title?: string;
  severity: SeverityLevel;
  description: string;
  riskScore: number;
  affectedHosts: string[];
  published?: string;
  lastModified?: string;
  references?: string[];
  selected?: boolean;
}

/** Extended vulnerability with source attribution (multi-source views). */
export interface VulnerabilityItemWithSources extends VulnerabilityItem {
  sources: SourceAttribution[];
  port?: number;
  service_info?: string;
  first_detected?: string;
  last_confirmed?: string;
  confidence_score?: number;
}

/* ------------------------------------------------------------------ */
/*  Filter types                                                       */
/* ------------------------------------------------------------------ */

/** Advanced filter state for the vulnerability navigator. */
export interface AdvancedFilters {
  riskScoreRange: [number, number];
  dateRange: string;
  hasExploit: boolean | null;
  hasFixAvailable: boolean | null;
  affectedHostsRange: [number, number];
  selectedTags: string[];
}

/** Default advanced filters (no filtering applied). */
export const DEFAULT_ADVANCED_FILTERS: AdvancedFilters = {
  riskScoreRange: [0, 10],
  dateRange: "all",
  hasExploit: null,
  hasFixAvailable: null,
  affectedHostsRange: [0, Infinity],
  selectedTags: [],
};

/* ------------------------------------------------------------------ */
/*  Helpers                                                            */
/* ------------------------------------------------------------------ */

/** Source filter options for multi-source views. */
export const SOURCE_FILTER_OPTIONS = [
  { value: "nmap", label: "Nmap", color: "blue" },
  { value: "agent", label: "Agent", color: "green" },
  { value: "rustscan", label: "RustScan", color: "orange" },
  { value: "manual", label: "Manual", color: "purple" },
  { value: "naabu", label: "Naabu", color: "cyan" },
] as const;

/** Confidence filter options for source confidence filtering. */
export const CONFIDENCE_FILTER_OPTIONS = [
  { value: "high", label: "High (90%+)", min: 0.9, max: 1.0 },
  { value: "medium", label: "Medium (70-89%)", min: 0.7, max: 0.89 },
  { value: "low", label: "Low (<70%)", min: 0.0, max: 0.69 },
] as const;

/* ------------------------------------------------------------------ */
/*  Vulnerability Detail Page types                                    */
/* ------------------------------------------------------------------ */

// Re-export CveItem and related types from the router for convenience
export type {
  CveItem,
  CveTag,
  LangString,
  Reference,
  Metrics,
  CvssV31,
  CvssDataV31,
  Weakness,
  Config,
  CpeMatch,
  VendorComment,
} from "~/server/api/routers/vulnerability";

/** Tab types for the vulnerability detail page. */
export type VulnTabType = "summary" | "nvd-details" | "remediation";

/** Extracted CPE info for display. */
export interface CpeInfo {
  vendor: string;
  product: string;
  version: string;
  uri: string;
}

/** An affected host for the affected systems table. */
export interface AffectedHost {
  hostname: string;
  ip: string;
  os: string;
  lastSeen?: string;
}

/** CVSS attack surface metrics for the hero card. */
export interface AttackSurface {
  attackVector: string;
  attackComplexity: string;
  privilegesRequired: string;
  userInteraction: string;
}

/** CIA impact ratings. */
export interface CiaImpact {
  confidentiality: string;
  integrity: string;
  availability: string;
}

/** The primary data contract between useVulnerabilityData and all vuln page components. */
export interface VulnPageData {
  /** Raw CVE item from the NVD API */
  cve: import("~/server/api/routers/vulnerability").CveItem;
  /** CVSS v3.1 base score (0-10) */
  cvssScore: number;
  /** Severity label (CRITICAL, HIGH, MEDIUM, LOW, NONE) */
  severity: string;
  /** CVSS vector string */
  vectorString: string;
  /** Attack surface metrics */
  attackSurface: AttackSurface;
  /** CIA impact ratings */
  ciaImpact: CiaImpact;
  /** Extracted CPE info */
  cpeInfo: CpeInfo;
  /** Affected hosts from the environment */
  affectedHosts: AffectedHost[];
  /** Count of affected hosts */
  affectedHostsCount: number;
  /** English description */
  description: string;
  /** Short description of the affected software (from Wikipedia, best-effort). */
  productDescription?: string;
}
