/**
 * useVulnerabilityData â€” single data hook for the Vulnerability Detail page.
 *
 * Consolidates:
 * - CVE data fetch (getVulnerability)
 * - Affected hosts fetch (getAffectedHosts)
 * - Derived values: cvssScore, severity, attackSurface, ciaImpact, cpeInfo
 *
 * Returns a clean typed VulnPageData object + loading / error flags.
 */

import { api } from "~/utils/api";
import type {
  VulnPageData,
  AttackSurface,
  CiaImpact,
  CpeInfo,
  AffectedHost,
} from "~/components/vulnerability/types";
import type { CveItem } from "~/server/api/routers/vulnerability";

/* ------------------------------------------------------------------ */
/*  Empty / default CveItem for pre-load state                         */
/* ------------------------------------------------------------------ */

const emptyCVEItem: CveItem = {
  id: "",
  sourceIdentifier: "",
  vulnStatus: "",
  published: "",
  lastModified: "",
  cveTags: [],
  descriptions: [],
  references: [],
  weaknesses: [],
  configurations: [],
  vendorComments: [],
  metrics: {
    cvssMetricV40: [],
    cvssMetricV31: [],
    cvssMetricV30: [],
    cvssMetricV2: [],
  },
};

/* ------------------------------------------------------------------ */
/*  Derivation helpers                                                 */
/* ------------------------------------------------------------------ */

function deriveCvss(cve: CveItem): {
  score: number;
  severity: string;
  vectorString: string;
} {
  const v31 = cve.metrics?.cvssMetricV31?.[0]?.cvssData;
  const v30 = cve.metrics?.cvssMetricV30?.[0]?.cvssData;
  const data = v31 ?? v30;
  return {
    score: data?.baseScore ?? 0,
    severity: data?.baseSeverity ?? "NONE",
    vectorString: data?.vectorString ?? "",
  };
}

function deriveAttackSurface(cve: CveItem): AttackSurface {
  const data =
    cve.metrics?.cvssMetricV31?.[0]?.cvssData ??
    cve.metrics?.cvssMetricV30?.[0]?.cvssData;
  return {
    attackVector: data?.attackVector ?? "N/A",
    attackComplexity: data?.attackComplexity ?? "N/A",
    privilegesRequired: data?.privilegesRequired ?? "N/A",
    userInteraction: data?.userInteraction ?? "N/A",
  };
}

function deriveCiaImpact(cve: CveItem): CiaImpact {
  const data =
    cve.metrics?.cvssMetricV31?.[0]?.cvssData ??
    cve.metrics?.cvssMetricV30?.[0]?.cvssData;
  return {
    confidentiality: data?.confidentialityImpact ?? "N/A",
    integrity: data?.integrityImpact ?? "N/A",
    availability: data?.availabilityImpact ?? "N/A",
  };
}

function deriveCpeInfo(cve: CveItem): CpeInfo {
  const firstCpe =
    cve.configurations?.[0]?.nodes?.[0]?.cpeMatch?.[0]?.criteria ?? "";
  // CPE 2.3 format: cpe:2.3:a:vendor:product:version:...
  const parts = firstCpe.split(":");
  return {
    vendor: parts[3] ?? "Unknown",
    product: parts[4] ?? "Unknown",
    version: parts[5] ?? "*",
    uri: firstCpe,
  };
}

function deriveDescription(cve: CveItem): string {
  return (
    cve.descriptions?.find((d) => d.lang === "en")?.value ??
    cve.descriptions?.[0]?.value ??
    "No description available."
  );
}

/* ------------------------------------------------------------------ */
/*  Hook                                                               */
/* ------------------------------------------------------------------ */

export function useVulnerabilityData(vulnId: string | undefined) {
  const {
    data: rawCve,
    isLoading: cveLoading,
    isError: cveError,
  } = api.vulnerability.getVulnerability.useQuery(
    { id: vulnId ?? "" },
    { enabled: !!vulnId },
  );

  const {
    data: affectedHosts,
    isLoading: hostsLoading,
  } = api.vulnerability.getAffectedHosts.useQuery(
    { cveId: vulnId ?? "" },
    { enabled: !!vulnId },
  );

  const cve = rawCve ?? emptyCVEItem;
  const hosts: AffectedHost[] = affectedHosts ?? [];
  const cvss = deriveCvss(cve);
  const cpeInfo = deriveCpeInfo(cve);

  // Best-effort software description from Wikipedia
  const { data: swDesc } = api.vulnerability.getSoftwareDescription.useQuery(
    { vendor: cpeInfo.vendor, product: cpeInfo.product },
    { enabled: cpeInfo.vendor !== "Unknown" && cpeInfo.product !== "Unknown" },
  );

  const data: VulnPageData = {
    cve,
    cvssScore: cvss.score,
    severity: cvss.severity,
    vectorString: cvss.vectorString,
    attackSurface: deriveAttackSurface(cve),
    ciaImpact: deriveCiaImpact(cve),
    cpeInfo,
    affectedHosts: hosts,
    affectedHostsCount: hosts.length,
    description: deriveDescription(cve),
    productDescription: swDesc?.description ?? undefined,
  };

  return {
    data,
    isLoading: cveLoading || hostsLoading,
    isError: cveError,
    isEmpty: !rawCve,
  };
}
