import { type VulnerabilityViewItem } from "~/components/VulnerabilityTableViews";
import { type VulnerabilityTableData } from "~/types/scanTypes";
import { type VulnTableData } from "~/components/vulnerability/VulnColumns";
import { normalizeSeverity } from "~/utils/riskScoreCalculator";

/**
 * Converts vulnerabilities from the Scanner page format to the common format
 */
export function adaptScannerVulnerabilities(
  vulns: any[]
): VulnerabilityViewItem[] {
  return vulns.map((vuln) => ({
    id: vuln.cve || vuln.vid || vuln.title || "unknown",
    title: vuln.cve || vuln.title || "Unknown Vulnerability",
    description: vuln.description || "No description available",
    severity: standardizeSeverity(vuln.severity || "MEDIUM"),
    riskScore:
      typeof vuln.riskScore !== "undefined"
        ? vuln.riskScore
        : typeof vuln.cvss !== "undefined"
        ? vuln.cvss
        : 0,
    affectedHosts: vuln.affectedHosts || vuln.hostCount || vuln.count || 0,
    published: vuln.published || "",
  }));
}

/**
 * Converts vulnerabilities from the Vulnerability page format to the common format
 */
export function adaptVulnerabilityPageData(
  vulns: any[]
): VulnerabilityViewItem[] {
  return vulns.map((vuln) => ({
    id: vuln.cve || vuln.vid || vuln.title || "unknown",
    title: vuln.cve || vuln.title || "Unknown Vulnerability",
    description: vuln.description || "No description available",
    severity: standardizeSeverity(vuln.severity || "MEDIUM"),
    riskScore:
      typeof vuln.riskScore !== "undefined"
        ? vuln.riskScore
        : typeof vuln.cvss !== "undefined"
        ? vuln.cvss
        : 0,
    affectedHosts: vuln.affectedHosts || vuln.hostCount || vuln.count || 0,
    published: vuln.published || "",
    lastModified: vuln.lastModified || "",
    references: vuln.references || [],
  }));
}

/**
 * Simple severity sorter function that can be used with array.sort()
 */
export function sortBySeverity(
  a: VulnerabilityViewItem,
  b: VulnerabilityViewItem
): number {
  const severityOrder = {
    CRITICAL: 0,
    HIGH: 1,
    MEDIUM: 2,
    LOW: 3,
    INFORMATIONAL: 4,
  };

  const aSeverity = a.severity.toUpperCase();
  const bSeverity = b.severity.toUpperCase();

  return (
    (severityOrder[aSeverity as keyof typeof severityOrder] || 999) -
    (severityOrder[bSeverity as keyof typeof severityOrder] || 999)
  );
}

/**
 * @deprecated Use `normalizeSeverity` from `~/utils/riskScoreCalculator` instead.
 * Kept as a re-export for backward compatibility.
 */
export function standardizeSeverity(severity: string): string {
  if (!severity) return "MEDIUM";
  const canonical = normalizeSeverity(severity);
  // normalizeSeverity returns lowercase; callers of standardizeSeverity expect UPPERCASE
  return canonical === "info" ? "INFORMATIONAL" : canonical.toUpperCase();
}
