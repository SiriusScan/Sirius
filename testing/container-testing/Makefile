# SiriusScan Docker Testing Makefile
# Provides easy commands for testing and development

.PHONY: help build test test-build test-health test-integration test-all test-security clean logs lint-docs lint-docs-quick lint-agents lint-agents-quick lint-agent-index regenerate-agents regenerate-agent check-agent-sync

# Default target
help:
	@echo "SiriusScan Docker Testing Commands"
	@echo "=================================="
	@echo ""
	@echo "Build Commands:"
	@echo "  build-base     Build base configuration"
	@echo "  build-dev      Build development configuration"
	@echo "  build-prod     Build production configuration"
	@echo "  build-all      Build all configurations"
	@echo ""
	@echo "Test Commands:"
	@echo "  test-build     Test individual container builds"
	@echo "  test-health    Test service health checks"
	@echo "  test-integration Test service integration"
	@echo "  test-security  Run security/auth penetration tests"
	@echo "  test-all       Run all tests"
	@echo ""
	@echo "Development Commands:"
	@echo "  dev            Start development environment"
	@echo "  prod           Start production environment"
	@echo "  stop           Stop all services"
	@echo "  restart        Restart all services"
	@echo ""
	@echo "Utility Commands:"
	@echo "  clean          Clean up containers and images"
	@echo "  logs           Show logs for all services"
	@echo "  status         Show status of all services"
	@echo ""
	@echo "Documentation Commands:"
	@echo "  lint-docs      Run full documentation linting"
	@echo "  lint-docs-quick Run quick documentation checks"
	@echo "  lint-index     Check documentation index completeness"
	@echo ""
	@echo "Agent Identity Commands:"
	@echo "  regenerate-agents   Regenerate all agent identities"
	@echo "  regenerate-agent    Regenerate specific agent (PRODUCT=name)"
	@echo "  check-agent-sync    Check if agent identities need regeneration"
	@echo "  lint-agents         Run full agent identity linting"
	@echo "  lint-agents-quick   Run quick agent checks"
	@echo "  lint-agent-index    Check agent identity index completeness"

# Build commands
build-base:
	@echo "ğŸ”¨ Building base configuration..."
	docker compose config --quiet
	@echo "âœ… Base configuration is valid"

build-dev:
	@echo "ğŸ”¨ Building development configuration..."
	docker compose -f docker-compose.yaml -f docker-compose.dev.yaml config --quiet
	@echo "âœ… Development configuration is valid"

build-prod:
	@echo "ğŸ”¨ Building production configuration..."
	docker compose config --quiet
	@echo "âœ… Production configuration is valid (base docker-compose.yaml)"

build-all: build-base build-dev build-prod
	@echo "ğŸ‰ All configurations are valid!"

# Test commands
test-build:
	@echo "ğŸ§ª Running build tests..."
	./test-build.sh

test-health:
	@echo "ğŸ¥ Running health tests..."
	./test-health.sh

test-integration:
	@echo "ğŸ”— Running integration tests..."
	./test-integration.sh

test-security:
	@echo "ğŸ”’ Running security penetration tests..."
	cd ../security && go run .
	@echo "âœ… Security tests completed!"

test-all: test-build test-health test-integration
	@echo "ğŸ‰ All tests completed!"

# Development commands
dev:
	@echo "ğŸš€ Starting development environment..."
	docker compose -f docker-compose.yaml -f docker-compose.dev.yaml up -d
	@echo "âœ… Development environment started"
	@echo "ğŸŒ UI: http://localhost:3000"
	@echo "ğŸ”Œ API: http://localhost:9001"
	@echo "âš™ï¸  Engine: http://localhost:5174"

prod:
	@echo "ğŸš€ Starting production environment..."
	docker compose up -d
	@echo "âœ… Production environment started (base docker-compose.yaml is production-ready)"
	@echo "ğŸŒ UI: http://localhost:3000"
	@echo "ğŸ”Œ API: http://localhost:9001"
	@echo "âš™ï¸  Engine: http://localhost:5174"

stop:
	@echo "ğŸ›‘ Stopping all services..."
	docker compose down
	@echo "âœ… All services stopped"

restart: stop dev
	@echo "ğŸ”„ Services restarted"

# Utility commands
clean:
	@echo "ğŸ§¹ Cleaning up containers and images..."
	docker compose down --volumes --remove-orphans
	docker system prune -f
	@echo "âœ… Cleanup completed"

logs:
	@echo "ğŸ“‹ Showing logs for all services..."
	docker compose logs -f

status:
	@echo "ğŸ“Š Service Status:"
	docker compose ps

# Quick test for CI/CD
ci-test: build-all test-build
	@echo "âœ… CI/CD tests passed!"

# Full validation
validate: build-all test-all
	@echo "ğŸ‰ Full validation completed successfully!"

# Documentation linting commands
lint-docs:
	@echo "ğŸ“š Running full documentation linting..."
	../../scripts/documentation/lint-docs.sh
	@echo "âœ… Documentation linting completed!"

lint-docs-quick:
	@echo "ğŸ“š Running quick documentation checks..."
	../../scripts/documentation/lint-quick.sh
	@echo "âœ… Quick documentation checks completed!"

lint-index:
	@echo "ğŸ“š Running index completeness linting..."
	../../scripts/documentation/lint-index.sh
	@echo "âœ… Index linting completed!"

# Agent identity linting commands
lint-agents:
	@echo "ğŸ¤– Running full agent identity linting..."
	cd ../../scripts/agent-identities && npm run validate
	@echo "âœ… Agent identity linting completed!"

lint-agents-quick:
	@echo "ğŸ¤– Running quick agent checks..."
	cd ../../scripts/agent-identities && npm run validate
	@echo "âœ… Quick agent checks completed!"

lint-agent-index:
	@echo "ğŸ¤– Checking agent identity index..."
	cd ../../scripts/agent-identities && npm run check-sync
	@echo "âœ… Agent index linting completed!"

# Agent identity generation commands
regenerate-agents:
	@echo "ğŸ”„ Regenerating agent identities..."
	cd ../../scripts/agent-identities && npm run generate -- --all
	@echo "âœ… Agent identities regenerated!"

regenerate-agent:
	@echo "ğŸ”„ Regenerating $(PRODUCT) agent identity..."
	cd ../../scripts/agent-identities && npm run generate -- --product=$(PRODUCT)
	@echo "âœ… $(PRODUCT) agent identity regenerated!"

check-agent-sync:
	@echo "ğŸ” Checking agent identity sync status..."
	cd ../../scripts/agent-identities && npm run check-sync

# Full validation including documentation and agents
validate-all: build-all test-all lint-docs lint-agents
	@echo "ğŸ‰ Complete validation including documentation and agent identities completed successfully!"
